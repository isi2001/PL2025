---
output: 
  bookdown::html_document2:
    theme: united
    toc: true
    toc_float: true
    toc_depth: 2
    number_sections: false
lang: es
css: styles.css
---


```{=html}
<style>
  .section {
    border-top: 2px solid black;
    margin-top: 20px;
    padding-top: 10px;
  }
</style>
```

<div class="Análisis Análisis Descriptivo de Ante-Proyecto 
de Ley 2025 MOP">
  <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 100px; text-align: center;">Análisis Análisis Estadístico de Ante-Proyecto <br> de Ley 2025 MOP <br> Edición 2025 </div>
  <div style="text-align: center;">
  <img src="mop.jpeg" alt="" width="30%">
</div>
<div style="font-size: 1.9em; color: black; margin-top: 100px; text-align: center;">
  Departamento de Estadísticas y Gestión Institucional
</div>
<div style="font-size: 1.5em; color: black; margin-top: 100px; text-align: center;">
  Unidad Gestión del Conocimiento y Tecnología
</div>
<div class="fecha" style="text-align: center;">
  Febrero 2025
</div>




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE)
options(knitr.fig.caption = TRUE)
knitr::opts_knit$set(lang = "es")
knitr::opts_chunk$set(fig.cap = "Figura ")
```

```{r, include=FALSE}
library(knitr) ; library(kableExtra); library(ggplot2); library(tinytex); library(dplyr); library(scales); library(readxl); library(paletteer); library(viridis); library(gridExtra); library(ggrepel); library(htmltools); library(tidyr)
Sys.setlocale("LC_ALL", "es_ES.UTF-8") 
```

```{r}

#####################################################################################################

#Este es un análisis previo, para dejar la base de datos con el mismo formato de nombres de variables
#y categorizaciones de los respectivos gráficos


#####################################################################################################


# En esta sección, hice un vector de categorías 
# para que después en las tablas y gráficos
# las regiones se vean ordenadas de 1-17(esta última es
# interregional)

#el orden_regiones es el orden de las regiones pero para los gráficos, mientras que 
#orden_regiones_tab es el orden para las tablas. Todo esto con el fin de que 



orden_regiones <- c("INTERREGIONAL","MAGALLANES","AYSÉN","LOS LAGOS","LOS RÍOS","LA ARAUCANÍA","BIOBÍO","ÑUBLE","MAULE",
                    "O'HIGGINS", "METROPOLITANA","VALPARAÍSO","COQUIMBO","ATACAMA","ANTOFAGASTA","TARAPACÁ","ARICA Y PARINACOTA")




PROYECCIONES_POBmulti <- read_excel("PROYECCIONES_POBmulti.xlsx")



BASE <- read_excel("BASE.xlsx")
 
 
 #############################################
 # Añadiendo la Abreviación de los servicios #
 #############################################
 
 BASE <- BASE %>% mutate(Servicio = case_when(Servicio == "Dirección de Arquitectura" ~ "DA",
                                              Servicio == "Dirección de Obras Hidráulicas" ~ "DOH",
                                              Servicio == "Dirección de Vialidad" ~ "DV",
                                              Servicio == "Dirección de Obras Portuarias" ~ "DOP",
                                              Servicio == "Dirección de Aeropuertos" ~ "DAP",
                                              Servicio == "Dirección de Planeamiento" ~ "DP",
                                Servicio == "Subdirección de Servicios Sanitarios Rurales" ~ "SSR",
                Servicio == "Conservaciones por Administración Directa - Dirección de Vialidad"  ~ "DV",
            Servicio == "Conservaciones por Administración Directa - Dirección de Aeropuertos" ~ "DAP",
            Servicio == "Dirección General de Concesiones de Obras Públicas" ~ "DGC",
                                              Servicio == "Dirección General de Aguas" ~ "DGA",
            Servicio == "Dirección General de Aguas - Gestión Hídrica y Organizaciones" ~ "DGA",
            Servicio == "Instituto Nacional de Hidráulica"  ~ "INH",
            Servicio == "Superintendencia de Servicios Sanitarios" ~ "SISS"))
 
 

### Juntamos en la misma categoría Adaptación y ADAPTACIÓN
### ya que se asume que se refieren a lo mismo.


BASE <- BASE %>%
  mutate(`Cambio Climatico` = case_when(
    `Cambio Climatico` == "Adaptación" ~ "ADAPTACIÓN",
    TRUE ~ `Cambio Climatico` 
  )) 



### Creamos una categoría nueva que agrupa el NO y el NA de Cambio ### Climático

BASE <- BASE %>%
  mutate(CambioClimaticoA = case_when(
    `Cambio Climatico` == "NO" ~ NA,
    TRUE ~ `Cambio Climatico` 
  )) 



### Creamos una categoría otros para aquellos servicios que 
### tengan poca presencia a nivel presupuestario, con el fin de ### que se pueda ver mejor en un gráfico.



BASE <- BASE %>%
  mutate(SERVICIOS_A = case_when(
    Servicio %in% c("INH", "SISS", "DP", "DGA", "DA") ~ "OTROS",
    TRUE ~ Servicio
  ))



## Aquí, agrupamos por categoría de programa dipres para ver el ## desglose





BASE <- BASE %>%  mutate(AGUA_DIPRES = case_when(`Programa dipres` == "GRANDES OBRAS DE RIEGO" ~ "RIEGO",
                                                 `Programa dipres` == "CONSERVACION DE OBRAS DE RIEGO" ~ "RIEGO",
                                                 `Programa dipres` ==  "OBRAS MEDIANAS DE RIEGO" ~ "RIEGO",
                                                 `Programa dipres` ==  "EXPLOTACION DE OBRAS DE RIEGO" ~ "RIEGO",
                                                 `Programa dipres` ==  "OBRAS DE RIEGO" ~ "RIEGO",
                                                 `Programa dipres` == "AGUA POTABLE RURAL DISPERSO" ~ "CONSUMO HUMANO",
                                                 `Programa dipres` == "AGUA POTABLE RURAL SEMI CONCENTRADO" ~ "CONSUMO HUMANO",
                                                 `Programa dipres` == "AGUA POTABLE RURAL CONCENTRADO" ~ "CONSUMO HUMANO",
                                                 `Programa dipres` == "ESTUDIO BÁSICO" ~ "ESTUDIOS Y OTROS",
                                                 `Programa dipres` == "ESTUDIOS" ~ "ESTUDIOS Y OTROS",
                                                 
                                                 `Programa dipres` == "OTROS" ~ "ESTUDIOS Y OTROS",
                                                 
                                                 TRUE ~ "GESTIÓN"))




#estas son las inversiones para cada región de acuerdo al 
#año 2024


Inv2024 <- c(129823086,83973170,174052596,165583748,155667167,215482639,424443541,197270782,249806178,168593498,298594294,255255930,221003257,442262402,128900221,156212197,208612150)

PL2024 <- as.data.frame(cbind(rev(orden_regiones),Inv2024))
PL2024$Inv2024 <- as.numeric(PL2024$Inv2024)
colnames(PL2024)[1] <- "RegionAB"

```

## Introducción

Este informe tiene como objetivo analizar la **inversión de ante-proyecto de Ley 2025** para tener una antesala de la inversión del Ministerio de Obras Públicas (MOP) del próximo año y unirlo al próximo producto de la Unidad de Gestión del Conocimiento y Tecnología que es un anuario PROPIR - B1 – LEY.

Para llevar a cabo este informe se utiliza la base de datos Ante-proyecto de Ley 2025 MOP del Departamento de Gestión Presupuestaria, la cual contiene variables como nombre iniciativa, región, comuna, servicio MOP, monto, entre otras.

Este informe se estructura con un análisis a nivel nacional, después uno por cada región, luego uno a nivel interregional, en cada una de estas secciones, se exponen los principales resultados y conclusiones.

## Nacional

Chile cuenta con 16 regiones, cada una recibe una inversión por parte del MOP, y por otro lado, también se financian proyectos interregionales. En total el país recibió \$3.829.909.407.000. A continuación mostramos las poblaciones e inversiones Ley 2025 por regiones y en proyectos interregionales.

```{r}
orden_regiones_tab <- rev(orden_regiones)


tab1 <- BASE %>% group_by(RegionAB) %>% summarise("Monto 2025" = sum(`Monto 2025`)) %>% mutate(
    RegionAB = factor(RegionAB, levels = orden_regiones)
  ) %>% arrange(RegionAB)




tab1 <- tab1 %>%
  mutate(
    IncDec = round(`Monto 2025` / Inv2024, 2),  
    Flecha = case_when(
      IncDec > 1 ~ "↑",  
      IncDec < 1 ~ "↓",  
      TRUE ~ "="         
    ),

    Label = paste0(
      scales::comma(`Monto 2025`, big.mark = ".", decimal.mark = ","),  
      "   ",  
      "<span style='color:red;'>", Flecha, "</span>",
      "   (", scales::comma(IncDec, big.mark = ".", decimal.mark = ","), ")"  
    )
  )


```






```{r, fig.cap=NULL}


ggplot(tab1, aes(y = RegionAB, x = `Monto 2025`)) +
  geom_bar(stat = "identity", fill = "darkblue", width = 0.6) +
  theme_minimal() +

  ggtext::geom_richtext(aes(label = Label), 
                        hjust = -0.1, size = 3, 
                        fill = NA, label.color = NA) + 
  scale_x_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"), 
    limits = c(0, 636729160),
    breaks = seq(0, 506729160, by = 100000000)) +
  labs(
    title = "Inversión 2025 a nivel Regional e Interregional",
    x = "Inversión (miles de pesos)",  
    y = "",
    caption =  "Figura 1: Inversión a nivel Regional e Interregional.\nFuente: Elaboración propia basada en datos del Departamento de Gestión Presupuestaria.\nNota: Sentido de la flecha (arriba/abajo) indica crecimiento o decrecimiento en comparación al presupuesto del año 2024 \ny entre paréntesis se indica el factor de crecimiento o decrecimiento."
  ) +
   theme(
     panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),  
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-150), color = "#555555"),
    axis.text.x = element_text(vjust = -0.3), 
    axis.text.y = element_text(size = 10, margin = margin(r = 20)),  
    axis.title.x = element_text(size = 10, margin = margin(t = 10)),
    axis.title.y = element_text(size = 10, margin = margin(r = 20)),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20))
  )


```





```{r, tab.cap=NULL}



tab_poblacion_nac <- PROYECCIONES_POBmulti %>%
  group_by(RegionAB) %>%
  summarise(
    "Población 2024" = sum(`Población censada`), 
    "Población 2025" = sum(`Suma de Poblacion 2025`), 
   "Crec/Decrec relativo de Población 2024 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(`Población censada`)) / first(`Población censada`) * 100, 2), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 2
),
    "Pobreza Multidimensional" = scales::comma(
  round(sum(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
)

  )


tab_monto_nac <- BASE %>%
  select(RegionAB, `Monto 2025`) %>%
  group_by(RegionAB) %>%
  summarise("Monto2025" = sum(`Monto 2025`))


tab_resumen_nac <- left_join(tab_poblacion_nac,tab_monto_nac, by = "RegionAB")  %>% 
  mutate(RegionAB = factor(RegionAB, levels = rev(orden_regiones))) %>% 
arrange(RegionAB) %>% 
  filter(RegionAB != "INTERREGIONAL")




tab_resumen_nac %>%
  mutate(`Población 2024` = scales::comma(`Población 2024`, big.mark = ".", decimal.mark = ","), 
         `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), 
         Monto2025 = scales::comma(Monto2025, big.mark = ".", decimal.mark = ","),
         `Pobreza Multidimensional`  = replace_na(`Pobreza Multidimensional`, "12.472")) %>%
  kable("html", 
        col.names = c("Región", "Población 2024", "Población 2025 (*)", 
                      "Crec/Decrec relativo de Población 2024 al 2025 (%)", 
                      "N° de personas en situación de pobreza multidimensional (**)", 
                      "Inversión")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>%
footnote(general = "<span style='font-size: 12px;'>Tabla 1: Poblaciones en regiones de Chile. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN 2022. (*) Población proyectada al 2025 según el INE. (**) Indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los montos de inversión presentados no incluyen la participación de las regiones en proyectos de carácter interregional.</span>", 
           general_title = "", 
           escape = FALSE) 
  
```




```{r, fig.cap= NULL}


tabREG_CAT <- BASE %>%
  group_by(RegionAB, Categoría) %>%
  summarise(TotalCat = sum(`Monto 2025`), .groups = "keep") %>%
  mutate(RegionAB = factor(RegionAB, levels = orden_regiones)) %>%
  arrange(RegionAB, Categoría)


ggplot(tabREG_CAT, aes(x = RegionAB, y = TotalCat, fill = Categoría)) +
  facet_wrap(~Categoría, scales = "free_y", nrow = 1, , labeller = as_labeller(c("Arrastre" = "Proyectos de Arrastre", "Nuevo" = "Proyectos Nuevos"))) + 
  geom_bar(stat = "identity", position = "stack", width = 0.6) + 
  geom_text(aes(label = scales::comma(TotalCat, big.mark = ".", decimal.mark = ",")), 
            hjust = -0.1, color = "black", size = 3) +
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    limits = function(x) {
      if ("Arrastre" %in% tabREG_CAT$Categoría) {
        c(0, 599565751)  
      } else {
        NULL  
      }
    }
  ) + 
  labs(
    caption = "Figura 2 : Inversión 2025 desglosada por proyectos nuevos y de arrastre. \n Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria",
    title = "Inversión 2025 por región y clasificación del proyecto (Arrastre y Nuevo)",
    x = "",
    y = "Inversión 2025 (miles de pesos)"
  ) +
  scale_fill_manual(values = alpha(c("cornsilk4", "darkblue"), .7)) +
  theme_minimal() +  
  theme(panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_text(angle = 45, hjust = 1),
    axis.ticks.y = element_blank(),
    legend.title = element_blank(),  
    legend.position = "none",
    strip.background = element_rect(color = "black", linewidth = 1),
    strip.text = element_text(size = 10),
     plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85), color = "#555555"),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20))) +
  coord_flip()


```


```{r, fig.cap=NULL}

tab_eje_ministerial_cat_nac <- BASE %>%
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = round(Monto2025 / total_global * 100,1) 
  )



colores <- c(
  "Integración territorial, conectividad y movilidad" = "#155E95",
  "Desarrollo Productivo, Social, Cultural y Científico" = "#98D8EF",
  "Seguridad Ciudadana y ante desastres naturales y emergencias" = "#4C7B8B",
  "Seguridad hídrica" = "#F4EDD3"
)




ggplot(tab_eje_ministerial_cat_nac, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyectos de Arrastre", "Nuevo" = "Proyectos Nuevos"))) +
  labs(
    title = "Inversión 2025 por clasificación de proyecto (arrastre y nuevo) y Eje Ministerial\n a nivel nacional", 
    x = "", 
    y = "Inversión (miles de pesos)", 
    fill = "",
    caption = "Figura 3: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales. \n Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."
  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(
      label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(porcentaje, big.mark = ".", decimal.mark = ","), "%"
)), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) +
  theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-55), color = "#555555")) +
  guides(fill = guide_legend(nrow = 3, byrow = TRUE)) + 
  scale_y_continuous(
  labels = label_number(scale = 1e-6, suffix = "M"),
  expand = expansion(mult = c(0, 0.3)) 
)  


```






```{r, fig.cap=NULL}



colores_servicios <- c("DV" = "#000957", "DGC" = "#155E95", "SSR" = "#4C585B","DOH" = "#7E99A3", 
            "DAP" = "#344CB7", "DOP" = "#98D8EF", "DA" = "#C4D9FF", "DGA" ="#1A3A6E", 
            "DP" = "#537895","ING" = "#A1BBCF", "OTROS" ="#D9ECFF", "SISS" ="#7B8FA6")


SERVICIOS_NAC <- BASE %>%
  group_by(SERVICIOS_A) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto2025 / sum(Monto2025) * 100,2))


ggplot(SERVICIOS_NAC , aes(x = reorder(SERVICIOS_A, -Monto2025), y = Monto2025, fill = SERVICIOS_A)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(Porcentaje, nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP a nivel nacional",
       x = "",
       y = "Inversión (miles de pesos)",
       caption = "Figura 4: Inversión 2025 para los servicios asociados al MOP. Fuente: Elaboración propia a partir de los datos del \n Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DA, DGA, DP, SISS e INH.") +
  scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_NAC$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
theme( panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),
    legend.position = "none", 
        plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
        plot.caption = element_text(size = 9, hjust = -0.2, margin = margin(t = 20, l =-40), color = "#555555"))



otros_data <- BASE %>%
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto / sum(Monto) * 100,4)) %>% 
  filter(Servicio %in% c("INH", "SISS", "DP", "DGA", "DA")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )




kable(otros_data, "html", col.names = c("Servicio", "Inversión", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  footnote(general = "<span style='font-size: 12px;'>Tabla 2: Servicios agrupados en 'Otros', los cuáles incluyen DA, DGA, DP, SISS e INH. Fuente: tabla construida a partir de los datos del Departamento de Gestión Presupuestaria</span>", 
           general_title = "", 
           escape = FALSE)


```







```{r, fig.cap = NULL}



       
CC_NA_OTROS <- BASE %>%
  mutate(CambioClimaticoA = ifelse(is.na(CambioClimaticoA), "No Aplica", "Otros")) %>%
  group_by(CambioClimaticoA) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round(Monto2025 / sum(Monto2025) * 100, 2),
    porcentaje = scales::comma(porcentaje, big.mark = ".", decimal.mark = ",", accuracy = 0.01),
    etiqueta = paste0(CambioClimaticoA, "\n", porcentaje, "%"),
    leyenda_texto = paste0(CambioClimaticoA, " - ", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))
  )

ggplot(CC_NA_OTROS, aes(x = "", y = Monto2025, fill = CambioClimaticoA)) +
  geom_bar(stat = "identity", width = 1, color = "white") + 
  coord_polar("y", start = 0) + 
  geom_text(
    aes(label = etiqueta), 
    position = position_stack(vjust = 0.5), 
    size = 4, 
    color = "black",
    fontface = "bold"
  ) +
  scale_fill_manual(
    values = alpha(c( "#578E7E","cornsilk3"), .7),
    labels = CC_NA_OTROS$leyenda_texto
  ) +
  labs(
    title = "Distribución porcentual de Inversiones 2025 por categoría de cambio climático",
    caption = "Figura 5: Inversiones 2025 según tipo de proyecto vinculado al cambio climático. Fuente: Elaboración propia a partir \n de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' incluye a aquellos proyectos \npertenecientes a 'Adaptación', 'Mitigación' y 'Mixto, mitigación y adaptación'. ",
    fill = "Categoría"
  ) +
  theme_minimal() +
  theme(
    legend.text = element_text(size=10),
    panel.grid = element_blank(), 
    axis.title = element_blank(), 
    axis.text = element_blank(),  
    axis.ticks = element_blank(),
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-27)),
    plot.title = element_text(size = 10, face = "bold")
  )



```



```{r, fig.cap = NULL}
CC_NAC <- BASE %>%
  group_by(CambioClimaticoA) %>%
  summarise(MONTO2025 = sum(`Monto 2025`, na.rm = TRUE)) %>% 
  mutate(
    Porcentaje = round((MONTO2025 / sum(MONTO2025)) * 100,2),
    Porcentaje = scales::comma(Porcentaje, big.mark = ".",decimal.mark = ",",accuracy = 0.01)
  ) %>% filter(CambioClimaticoA != "NA")


CC_NAC %>%
  mutate(MONTO2025 = scales::comma(MONTO2025, big.mark = ".", decimal.mark = ",")) %>% 
  kable(
    "html",
    col.names = c("Cambio Climático", "Inversión 2025", "Porcentaje")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    font_size = 14
  ) %>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 3: Desglose de la categoría 'Otros' de los proyectos relacionados a Cambio Climático. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria</span>", escape = FALSE, general_title = "")
```






```{r, fig.cap=NULL}


SH_NAC <- BASE %>%
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round((monto2025 / sum(monto2025)) * 100,2)
  )

ggplot(SH_NAC, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
  label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(porcentaje, nsmall = 1, decimal.mark = ","), "%)") ),
    fontface = "bold",
    vjust = 1.6,
    size = 2.7
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en nuevos proyectos del eje de Seguridad Hídrica a nivel nacional",
    x = NULL,
    y = "",
    caption = "Figura 6: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al eje ministerial de Seguridad Hídrica. \nFuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrado, agua potable rural concentrado y \nagua potable rural disperso. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."
  ) +
  theme_minimal() +
  theme(
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85), color = "#555555"),
    panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
    plot.title = element_text(size = 10, hjust = 1, face = "bold", margin = margin(b = 20)) ) +
  expand_limits(y = c(0, max(SH_NAC$porcentaje) + 5)) +
  scale_y_continuous(labels = scales::percent_format(scale = 1, decimal.mark = ","))



```






## Arica y Parinacota





```{r, fig.cap=NULL}

SERVICIOS_AYP <- BASE %>%
  filter(RegionAB == "ARICA Y PARINACOTA") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DAP", "DGA","DGC") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto2025 / sum(Monto2025) * 100),2)


ggplot(SERVICIOS_AYP , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(Porcentaje, nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la región de Arica y Parinacota",
       x = "",
       y = "Inversión (miles de pesos)", caption = "Figura 7: Inversión 2025 para los servicios asociados al MOP para la región de Arica y Parinacota. \nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' \ncomprende los servicios DAP, DGA y DGC."
) +
  scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_AYP$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),  
    legend.position = "none",
        plot.title = element_text(size = 12, face = "bold", hjust = 1.1, margin = margin(b = 20)),
        plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-20), color = "#555555"))



otros_data_AYP <- BASE %>%
  filter(RegionAB == "ARICA Y PARINACOTA") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DAP", "DGA","DGC")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 2), big.mark = ".", decimal.mark = ",")
  )


kable(otros_data_AYP, "html", col.names = c("Servicio", "Inversión 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 4: Servicios agrupados en ‘Otros’, los cuáles incluyen DAP, DGA y DGC para la región de Arica y Parinacota. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria </span>", general_title = "", escape = FALSE)

```






```{r, fig.cap=NULL}

tab_eje_ministerial_cat_AyP <- BASE %>%
  filter(RegionAB == "ARICA Y PARINACOTA") %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = Monto2025 / total_global * 100 
  )




ggplot(tab_eje_ministerial_cat_AyP, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyectos de Arrastre", "Nuevo" = "Proyectos Nuevos"))) +
  labs(
    x = "", 
    y = "Inversión (miles de pesos)",
    title = "Inversión 2025 por clasificación del proyecto (Arrastre y Nuevo)\n para la región de Arica y Parinacota",
    fill = "",
    caption = "Figura 8: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la región de \nArica y Parinacota. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."
  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje,2), big.mark = ".", decimal.mark = ","), "%"
)), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
  scale_fill_manual(values = colores) + 
  theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-30), color = "#555555")) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + 
  scale_y_continuous(
  labels = label_number(scale = 1e-6, suffix = "M"),
  expand = expansion(mult = c(0, 0.3)) 
)


```






```{r, fig.cap = NULL}

tab_poblacion_AyP <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "ARICA Y PARINACOTA") %>% 
  select(NombreComuna, `Población censada`, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2024" = sum(`Población censada`), 
    "Población 2025" = sum(`Suma de Poblacion 2025`), 
   "Crec/Decrec relativo de Población 2024 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(`Población censada`)) / first(`Población censada`) * 100, 2), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 2
),
    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
)

  )



tab_monto_AyP <- BASE %>%
  filter(RegionAB == "ARICA Y PARINACOTA") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))

  

tab_resumen_AyP <- left_join(tab_poblacion_AyP, tab_monto_AyP, by = "NombreComuna") 



tab_resumen_AyP %>%
  mutate(
    `Población 2024` = scales::comma(`Población 2024`, big.mark = ".", decimal.mark = ","),
    `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","),
    Monto2025 = ifelse(is.na(Monto2025), "Por definir", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))
  ) %>%
  kable("html", col.names = c("Comuna", "Población 2024", "Población 2025", "Crec/Decrec relativo (%) de Población 2024 al 2025", "N° de personas en situación de pobreza multidimensional", "Inversión")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%
  footnote(general = "<span style='font-size: 12px;'>Tabla 5: Poblaciones en la región de Arica y Parinacota. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN 2022. (*) Población proyectada al 2025 según el INE. (**) Indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores 'Por definir' en la columna Inversión corresponden a comunas que forman parte de proyectos intercomunales pero que no tienen un monto asociado.</span>", 
         general_title = "", 
         escape = FALSE)


```



```{r, fig.cap = NULL, tab.cap = NULL}


CC_NA_OTROS_AYP <- BASE %>%
  filter(RegionAB == "ARICA Y PARINACOTA") %>% 
  mutate(CambioClimaticoA = ifelse(is.na(CambioClimaticoA), "No Aplica", "Otros")) %>%
  group_by(CambioClimaticoA) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round(Monto2025 / sum(Monto2025) * 100, 2),
    porcentaje = scales::comma(porcentaje, big.mark = ".", decimal.mark = ",", accuracy = 0.01),
    etiqueta = paste0(CambioClimaticoA, "\n", porcentaje, "%"),
    leyenda_texto = paste0(CambioClimaticoA, " - ", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))
  )

ggplot(CC_NA_OTROS_AYP, aes(x = "", y = Monto2025, fill = CambioClimaticoA)) +
  geom_bar(stat = "identity", width = 1, color = "white") + 
  coord_polar("y", start = 0) + 
  geom_text(
    aes(label = etiqueta), 
    position = position_stack(vjust = 0.5), 
    size = 4, 
    color = "black",
    fontface = "bold"
  ) +
  scale_fill_manual(
    values = alpha(c( "#578E7E","cornsilk3"), .7),
    labels = CC_NA_OTROS_AYP$leyenda_texto
  ) +
  labs(
    title = "Distribución porcentual de inversiones 2025 por categoría de Cambio Climático\n para la región de Arica y Parinacota",
    fill = "Categoría",
    caption = "Figura 9: Inversiones 2025 según tipo de proyecto vinculado al cambio climático para la región de Arica y Parinacota. \nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' \nincluye a aquellos proyectos pertenecientes a 'Adaptación', 'Mitigación' y 'Mixto, mitigación y adaptación'."
  ) +
  theme_minimal() +
  theme(plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-40), color = "#555555"),
    legend.text = element_text(size=10),
    panel.grid = element_blank(), 
    axis.title = element_blank(), 
    axis.text = element_blank(),  
    axis.ticks = element_blank()
  )


```



```{r, fig.cap=NULL}
CC_AYP <- BASE %>%
  filter(RegionAB == "ARICA Y PARINACOTA") %>%  # Mover el filtro antes del group_by()
  group_by(CambioClimaticoA) %>%
  summarise(MONTO2025 = sum(`Monto 2025`, na.rm = TRUE)) %>% 
  mutate(
    Porcentaje = round((MONTO2025 / sum(MONTO2025)) * 100, 2),  
  ) %>% 
  filter(CambioClimaticoA != "NA") 




CC_AYP %>%
  mutate(MONTO2025 = scales::comma(MONTO2025, big.mark = ".", decimal.mark = ","),
         Porcentaje = number(Porcentaje, big.mark = ".", decimal.mark = ",", accuracy = 0.01)) %>% 
  kable(
    "html",
    col.names = c("Cambio Climático", "Inversión 2025", "Porcentaje"),
    position = "bottom"
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    font_size = 14
  ) %>% footnote(general = "<span style='font-size: 12px;'>Tabla 6: Desglose de la categoría ‘Otros’ de los proyectos relacionados a Cambio Climático para la región de Arica y Parinacota. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria.</span>", general_title = "", escape = FALSE)
```


```{r, fig.cap=NULL, tab.cap=NULL}


SH_AYP <- BASE %>%
  filter(RegionAB == "ARICA Y PARINACOTA") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round((monto2025 / sum(monto2025)) * 100,1)
  )

ggplot(SH_AYP, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(porcentaje, nsmall = 1, decimal.mark = ","), "%)") ),
    fontface = "bold",
    vjust = 1.6,
    size = 3
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nregión de Arica y Parinacota",
    x = NULL,
    y = "",
    caption = "Figura 10: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad \nHídrica para la región de Arica y Parinacota. Fuente: Elaboración propia a partir de datos del Departamento de \nGestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrado, agua potable rural concentrado y \nagua potable rural disperso. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."
  ) +
  theme_minimal() +
  theme(
    panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85), color = "#555555")
  ) +
  expand_limits(y = c(0, max(SH_AYP$porcentaje) + 5)) +
  scale_y_continuous(labels = scales::percent_format(scale = 1, decimal.mark = ","))



```








## Tarapacá



```{r, fig.cap = NULL}
SERVICIOS_TARAPACA <- BASE %>%
  filter(RegionAB == "TARAPACÁ") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DAP", "DGA","DGC","DOP") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto2025 / sum(Monto2025) * 100,3))


ggplot(SERVICIOS_TARAPACA , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(Porcentaje, nsmall = 1, decimal.mark = ","), "%)")),  
          vjust = -0.5, 
          size = 3, 
          color = "black", 
          fontface = "bold")+
  labs(title = "Distribución de Inversión 2025 por servicios MOP de la región de Tarapacá",
       x = "",
       y = "Inversión (miles de pesos)",
       caption = "Figura 11: Inversión 2025 para los servicios asociados al MOP para la región de Tarapacá. \nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DAP, DGA, DGC \ny DOP.") +
  scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_TARAPACA$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
         plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-40))
)



otros_data_TARAPACA <- BASE %>%
  filter(RegionAB == "TARAPACÁ") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DAP", "DGA","DGC","DOP")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_TARAPACA, "html", col.names = c("Servicio", "Inversión 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 7: Servicios agrupados en 'Otros', los cuáles incluyen DAP, DGA, DGC y DOP. Fuente: tabla construída a partir de los datos del Departamento de Gestión Presupuestaria</span>", general_title = "", escape = FALSE) 


```




```{r, fig.cap = NULL}

tab_eje_ministerial_cat_TPCA <- BASE %>%
  filter(RegionAB == "TARAPACÁ" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = round(Monto2025 / total_global * 100,1) 
  )




ggplot(tab_eje_ministerial_cat_TPCA, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyectos de Arrastre", "Nuevo" = "Proyectos Nuevos"))) +
  labs(
    x = "", 
    y = "Inversión (miles de pesos)", 
    fill = "",
     title = "Inversión 2025 por clasificación de proyecto (arrastre y nuevo) y eje ministerial \npara la región de Tarapacá",
    caption = "Figura 12: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la región \nde Tarapacá. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."
  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(porcentaje, big.mark = ".", decimal.mark = ","), "%"
)), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
  scale_fill_manual(values = colores)+ 
  theme(caption = "Figura 12: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la región de \n Tarapacá. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria.",
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-30), color = "#555555"))+
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) +
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )





```



```{r}
tab_poblacion_Tarapaca <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "TARAPACÁ") %>%  
  select(NombreComuna, `Población censada`, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
summarise(
    "Población 2024" = sum(`Población censada`), 
    "Población 2025" = sum(`Suma de Poblacion 2025`), 
  "Crec/Decrec relativo de Población 2024 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(`Población censada`)) / first(`Población censada`) * 100, 1), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 2
),
    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))


tab_monto_Tarapaca <- BASE %>%
  filter(RegionAB == "TARAPACÁ") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))


tab_resumen_Tarapaca <- left_join(tab_poblacion_Tarapaca,tab_monto_Tarapaca, by = "NombreComuna")

tab_resumen_Tarapaca %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
mutate(`Población 2024` = scales::comma(`Población 2024`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), 
       Monto2025 = ifelse(is.na(Monto2025), "Por definir", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))) %>%
  kable("html", col.names = c("Comuna", "Población 2024", "Población 2025 (*)", "Crec/Decrec relativo (%) de Población 2024 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "<span style='font-size: 12px;'>Tabla 8: Poblaciones e Inversiones 2025 en la región de Tarapacá. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN 2022. (*) Población proyectada al 2025 según el INE. (**) Indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores 'Por definir' en la columna Inversión corresponden a comunas que forman parte de proyectos intercomunales pero que no tienen un monto asociado.</span>", 
         general_title = "", 
         escape = FALSE)




```





```{r, fig.cap=NULL}
CC_NA_OTROS_TARAPACA <- BASE %>%
  filter(RegionAB == "TARAPACÁ") %>%
  mutate(CambioClimaticoA = ifelse(is.na(CambioClimaticoA), "No Aplica", "Otros")) %>%
  group_by(CambioClimaticoA) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round(Monto2025 / sum(Monto2025) * 100, 2),
    porcentaje = scales::comma(porcentaje, big.mark = ".", decimal.mark = ",", accuracy = 0.01),
    etiqueta = paste0(CambioClimaticoA, "\n", porcentaje, "%"),
    leyenda_texto = paste0(CambioClimaticoA, " - ", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))
  )

ggplot(CC_NA_OTROS_TARAPACA, aes(x = "", y = Monto2025, fill = CambioClimaticoA)) +
  geom_bar(stat = "identity", width = 1, color = "white") + 
  coord_polar("y", start = 0) + 
  geom_text(
    aes(label = etiqueta), 
    position = position_stack(vjust = 0.5), 
    size = 4, 
    color = "black",
    fontface = "bold"
  ) +
  scale_fill_manual(
    values = alpha(c( "#578E7E","cornsilk3"), .7),
    labels = CC_NA_OTROS_TARAPACA$leyenda_texto
  ) +
  labs(
    title = "Distribución porcentual de Inversión 2025 por categoría de Cambio Climático \n para la región de Tarapacá",
    fill = "Categoría",
    caption =  "Figura 13: Inversión 2025 según tipo de proyecto vinculado al Cambio Climático para la región de Tarapacá. \nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría \n'Otros' incluye a aquellos proyectos pertenecientes a 'Adaptación' 'Mitigación' y 'Mixto, mitigación y adaptación'. \nNota 2: La categoría 'No aplica incluye' aquellos proyectos categorizados como NA o No. "
  ) +
  theme_minimal() +
  theme(plot.title = element_text(size = 12, face = "bold", hjust = 0, margin = margin(b = 20)),
        plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555"),
    legend.text = element_text(size=10),
    panel.grid = element_blank(), 
    axis.title = element_blank(), 
    axis.text = element_blank(),  
    axis.ticks = element_blank()
  )


```


```{r, tab.cap=NULL}
CC_TARAPACA <- BASE %>%
  group_by(CambioClimaticoA) %>%
  filter(RegionAB == "TARAPACÁ") %>%
  summarise(MONTO2025 = sum(`Monto 2025`, na.rm = TRUE)) %>% 
  mutate(
    Porcentaje = round((MONTO2025 / sum(MONTO2025)) * 100,2),
    Porcentaje = scales::comma(Porcentaje, big.mark = ".",decimal.mark = ",",accuracy = 0.01)
  ) %>% filter(CambioClimaticoA != "NA")


CC_TARAPACA %>%
  mutate(MONTO2025 = scales::comma(MONTO2025, big.mark = ".", decimal.mark = ",")) %>% 
  kable(
    "html",
    col.names = c("Cambio Climático", "Inversión 2025", "Porcentaje"),
    position = "bottom"
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    font_size = 14
  ) %>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 9: Desglose de la categoría 'Otros' de los proyectos relacionados a Cambio Climático para la región de Tarapacá. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria</span>
", escape = FALSE, general_title = "")

```


```{r, fig.cap=NULL}


SH_TARAPACA <- BASE %>%
  filter(RegionAB == "TARAPACÁ") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round((monto2025 / sum(monto2025)) * 100,1)
  )

ggplot(SH_TARAPACA, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(porcentaje, nsmall = 1, decimal.mark = ","), "%)") ),
    fontface = "bold",
    vjust = 1.6,
    size = 2.7
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en nuevos proyectos del Eje de Seguridad Hídrica para la \nregión de Tarapacá",
    x = NULL,
    y = "Porcentaje del monto total",
    caption = "Figura 14: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al eje ministerial de Seguridad Hídrica \npara la región de Tarapacá. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrado, agua potable rural concentrado y \nagua potable rural disperso. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."

  ) +
  theme_minimal() +
  theme(
    panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
   plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85), color = "#555555")
  ) +
  scale_y_continuous(labels = scales::percent_format(scale = 1, decimal.mark = ","))+
  expand_limits(y = c(0, max(SH_TARAPACA$porcentaje) + 5))



```






## Antofagasta









```{r, fig.cap = NULL}
SERVICIOS_ANTOF <- BASE %>%
  filter(RegionAB == "ANTOFAGASTA") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DA", "DGA","DOP") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto2025 / sum(Monto2025) * 100,2))


ggplot(SERVICIOS_ANTOF , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(Porcentaje, nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la región de Antofagasta",
       x = "",
       y = "Inversión (miles de pesos)",
       caption = "Figura 15: Inversión 2025 para los servicios asociados al MOP para la región de Antofagasta. Fuente: Elaboración propia a \npartir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DA, DGA\n y DOP") +
  scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_ANTOF$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
         plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555")



)



otros_data_ANTOF <- BASE %>%
  filter(RegionAB == "ANTOFAGASTA") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DA", "DGA","DOP")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_ANTOF, "html", col.names = c("Servicio", "Inversión 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 10: Servicios agrupados en ‘Otros’, los cuáles incluyen DA, DGA y DOP para la región de Antofagasta. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.</span>
", general_title = "", escape = FALSE)

```






```{r, fig.cap = NULL}

tab_eje_ministerial_cat_ANTOF <- BASE %>%
  filter(RegionAB == "ANTOFAGASTA" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = round(Monto2025 / total_global * 100,2) 
  )






ggplot(tab_eje_ministerial_cat_ANTOF, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyectos de Arrastre", "Nuevo" = "Proyectos Nuevos"))) +
  labs(
    x = "", 
    y = "Inversión (miles de pesos)", 
    fill = "",
    title = "Inversión 2025 por Clasificación del Proyecto (Arrastre y Nuevo)\n para la región de Antofagasta",
    caption = "Figura 16: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la región de \nAntofagasta. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."

  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(porcentaje, big.mark = ".", decimal.mark = ","), "%"
)
), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
  theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555")) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + 
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )


```

```{r}
tab_poblacion_Antofagasta <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "ANTOFAGASTA") %>%  
  select(NombreComuna, `Población censada`, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2024" = first(`Población censada`),  
    "Población 2025" = first(`Suma de Poblacion 2025`),  
"Crec/Decrec relativo de Población 2024 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(`Población censada`)) / first(`Población censada`) * 100, 1), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 2
),

    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))




tab_monto_ANTOF <- BASE %>%
  filter(RegionAB == "ANTOFAGASTA") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))



tab_resumen_antof <- left_join(tab_poblacion_Antofagasta, tab_monto_ANTOF, by = "NombreComuna")



tab_resumen_antof  %>%  
mutate(`Población 2024` = scales::comma(`Población 2024`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), 
       Monto2025 = ifelse(is.na(Monto2025), "Por definir", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))) %>%
  
  mutate(NombreComuna = case_when(NombreComuna == "MARIA ELENA" ~ "MARÍA ELENA", NombreComuna == "OLLAGUE" ~ "OLLAGÜE", TRUE ~ NombreComuna)) %>% 
  
  kable("html", col.names = c("Comuna", "Población 2024", "Población 2025 (*)", "Crec/Decrec relativo (%) de Población 2024 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "<span style='font-size: 12px;'>Tabla 11: Poblaciones e Inversiones 2025 en la región de Antofagasta. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN 2022. (*) Población proyectada al 2025 según el INE. (**) Indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores 'Por definir' en la columna Inversión corresponden a comunas que forman parte de proyectos intercomunales pero que no tienen un monto asociado..</span>", 
         general_title = "", 
         escape = FALSE)


```




```{r, fig.cap=NULL}
CC_NA_OTROS_ANTOFAGASTA <- BASE %>%
  filter(RegionAB == "ANTOFAGASTA") %>%
  mutate(CambioClimaticoA = ifelse(is.na(CambioClimaticoA), "No Aplica", "Otros")) %>%
  group_by(CambioClimaticoA) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round(Monto2025 / sum(Monto2025) * 100, 2),
    porcentaje = scales::comma(porcentaje, big.mark = ".", decimal.mark = ",", accuracy = 0.01),
    etiqueta = paste0(CambioClimaticoA, "\n", porcentaje, "%"),
    leyenda_texto = paste0(CambioClimaticoA, " - ", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))
  )

ggplot(CC_NA_OTROS_ANTOFAGASTA, aes(x = "", y = Monto2025, fill = CambioClimaticoA)) +
  geom_bar(stat = "identity", width = 1, color = "white") + 
  coord_polar("y", start = 0) + 
  geom_text(
    aes(label = etiqueta), 
    position = position_stack(vjust = 0.5), 
    size = 4, 
    color = "black",
    fontface = "bold"
  ) +
  scale_fill_manual(
    values = alpha(c( "#578E7E","cornsilk3"), .7),
    labels = CC_NA_OTROS_ANTOFAGASTA$leyenda_texto
  ) +
  labs(
    title = "Distribución porcentual de Inversión 2025 por categoría de Cambio Climático  \n para la región de Antofagasta",
    fill = "Categoría",
       caption =  "Figura 17: Inversión 2025 según tipo de proyecto vinculado al Cambio Climático para la región de Antofagasta. \nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría \n'Otros' incluye a aquellos proyectos pertenecientes a 'Adaptación' 'Mitigación' y 'Mixto, mitigación y adaptación'. "
  
  ) +
  theme_minimal() +
  theme(
    legend.text = element_text(size=10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0, margin = margin(b = 20)),
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555"),
    panel.grid = element_blank(), 
    axis.title = element_blank(), 
    axis.text = element_blank(),  
    axis.ticks = element_blank()
  )


```


```{r}
CC_ANTOFAGASTA <- BASE %>%
  group_by(CambioClimaticoA) %>%
  filter(RegionAB == "ANTOFAGASTA") %>%
  summarise(MONTO2025 = sum(`Monto 2025`, na.rm = TRUE)) %>% 
  mutate(
    Porcentaje = round((MONTO2025 / sum(MONTO2025)) * 100,2),
    Porcentaje = scales::comma(Porcentaje, big.mark = ".",decimal.mark = ",",accuracy = 0.01)
  ) %>% filter(CambioClimaticoA != "NA")


CC_ANTOFAGASTA %>%
  mutate(MONTO2025 = scales::comma(MONTO2025, big.mark = ".", decimal.mark = ",")) %>% 
  kable(
    "html",
    col.names = c("Cambio Climático", "Inversión 2025", "Porcentaje")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    font_size = 14
  )%>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 12: Desglose de la categoría 'Otros' de los proyectos relacionados a Cambio Climático para la región de Antofagasta. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria</span>", escape = FALSE, general_title = "")

```

```{r, fig.cap = NULL}


SH_ANTOF <- BASE %>%
  filter(RegionAB == "ANTOFAGASTA") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round((monto2025 / sum(monto2025)) * 100,2)
  )

ggplot(SH_ANTOF, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
     aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(porcentaje, nsmall = 1, decimal.mark = ","), "%)")
    ),
    fontface = "bold",
    vjust = 1.6,
    size = 3
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nregión de Antofagasta",
    x = NULL,
    y = "",
    caption = "Figura 18: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la región de Antofagasta. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrado, agua potable rural concentrado y \nagua potable rural disperso. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."

  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-78), color = "#555555")

  ) +
  scale_y_continuous(labels = scales::percent_format(scale = 1, decimal.mark = ","))+
  expand_limits(y = c(0, max(SH_ANTOF$porcentaje) + 5))



```



## Atacama




```{r, fig.cap=NULL}

SERVICIOS_ATACAMA <- BASE %>%
  filter(RegionAB == "ATACAMA") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DAP", "DOP", "SSR") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto2025 / sum(Monto2025) * 100,2))


ggplot(SERVICIOS_ATACAMA , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(Porcentaje, nsmall = 1, decimal.mark = ","), "%)")
    ), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por Servicios MOP para la región de Atacama",
       x = "",
       y = "Inversión (miles de pesos)",
       caption = "Figura 19: Inversión 2025 para los servicios asociados al MOP para la región de Atacama. \nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DAP, SSR \ny DOP.") +
  scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_ATACAMA$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),  
    legend.position = "none",
        plot.title = element_text(size = 12, face = "bold", hjust = 1.1, margin = margin(b = 20)),
        plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555"))



otros_data_ATACAMA <- BASE %>%
  filter(RegionAB == "ATACAMA") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DAP", "DOP", "SSR")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_ATACAMA, "html", col.names = c("Servicio", "Inversión 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 13: Servicios agrupados en 'Otros', los cuáles incluyen DAP, SSR y DOP. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria</span>", general_title = "", escape = FALSE) 


```


```{r, fig.cap = NULL}

tab_eje_ministerial_cat_ATCMA <- BASE %>%
  filter(RegionAB == "ATACAMA" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = round(Monto2025 / total_global * 100,1) 
  )





ggplot(tab_eje_ministerial_cat_ATCMA, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyectos de Arrastre", "Nuevo" = "Proyectos Nuevos"))) +
  labs(
    x = "", 
    y = "Inversión (miles de pesos)", 
    fill = "",
     title = "Inversión 2025 por clasificación de proyecto (arrastre y nuevo) y Eje Ministerial \npara la región de Atacama",
    caption = "Figura 20: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la región \nde Atacama. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."
  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(porcentaje, big.mark = ".", decimal.mark = ","), "%"
)), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
  scale_fill_manual(values = colores)+ 
  theme(caption = "Figura 20: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la región de \n Tarapacá. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria.",
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555"))+
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) +
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )




```

```{r, fig.cap = NULL}


tab_poblacion_Atacama <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "ATACAMA") %>% 
  select(NombreComuna, `Población censada`, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
summarise(
    "Población 2024" = sum(`Población censada`), 
    "Población 2025" = sum(`Suma de Poblacion 2025`), 
   "Crec/Decrec relativo de Población 2024 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(`Población censada`)) / first(`Población censada`) * 100, 1), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 2
),
    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))



tab_monto_Atacama <-  BASE %>%
  filter(RegionAB == "ATACAMA") %>%  
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))


tab_resumen_Atacama <- left_join(tab_poblacion_Atacama, tab_monto_Atacama, by = "NombreComuna")



tab_resumen_Atacama %>% 
mutate(`Población 2024` = scales::comma(`Población 2024`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), 
       Monto2025 = ifelse(is.na(Monto2025), "Por definir", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))) %>%
  
  mutate(NombreComuna = case_when(NombreComuna == "COPIAPO" ~ "COPIAPÓ", TRUE ~ NombreComuna)) %>%
  
  kable("html", col.names = c("Comuna", "Población 2024", "Población 2025 (*)", "Crec/Decrec relativo (%) de Población 2024 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "<span style='font-size: 12px;'>Tabla 14: Poblaciones e Inversiones 2025 en la región de Atacama. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN 2022. (*) Población proyectada al 2025 según el INE. (**) Indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores 'Por definir' en la columna Inversión corresponden a comunas que forman parte de proyectos intercomunales pero que no tienen un monto asociado.</span>", 
         general_title = "", 
         escape = FALSE)


```






```{r, fig.cap = NULL}
CC_NA_OTROS_ATACAMA <- BASE %>%
  filter(RegionAB == "ATACAMA") %>%
  mutate(CambioClimaticoA = ifelse(is.na(CambioClimaticoA), "No Aplica", "Otros")) %>%
  group_by(CambioClimaticoA) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round(Monto2025 / sum(Monto2025) * 100, 2),
    porcentaje = scales::comma(porcentaje, big.mark = ".", decimal.mark = ",", accuracy = 0.01),
    etiqueta = paste0(CambioClimaticoA, "\n", porcentaje, "%"),
    leyenda_texto = paste0(CambioClimaticoA, " - ", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))
  )

ggplot(CC_NA_OTROS_ATACAMA, aes(x = "", y = Monto2025, fill = CambioClimaticoA)) +
  geom_bar(stat = "identity", width = 1, color = "white") + 
  coord_polar("y", start = 0) + 
  geom_text(
    aes(label = etiqueta), 
    position = position_stack(vjust = 0.5), 
    size = 4, 
    color = "black",
    fontface = "bold"
  ) +
  scale_fill_manual(
    values = alpha(c( "#578E7E","cornsilk3"), .7),
    labels = CC_NA_OTROS_ATACAMA$leyenda_texto
  ) +
  labs(
    title = "Distribución porcentual de inversiones 2025 por categoría de Cambio Climático\n para la región de Atacama",
    caption = "Figura 21: Inversión 2025 según tipo de proyecto vinculado al Cambio Climático para la región de Atacama. \nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría \n'Otros' incluye a aquellos proyectos pertenecientes a 'Adaptación' 'Mitigación' y 'Mixto, mitigación y adaptación'. ",
    fill = "Categoría"
  ) +
  theme_minimal() +
  theme(plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-47), color = "#555555"),
    legend.text = element_text(size=10),
    panel.grid = element_blank(), 
    axis.title = element_blank(), 
    axis.text = element_blank(),  
    axis.ticks = element_blank()
  )


```




```{r, fig.cap = NULL}
CC_ATACAMA <- BASE %>%
  group_by(CambioClimaticoA) %>%
  filter(RegionAB == "ATACAMA") %>%
  summarise(MONTO2025 = sum(`Monto 2025`, na.rm = TRUE)) %>% 
  mutate(
    Porcentaje = round((MONTO2025 / sum(MONTO2025)) * 100,2),
    Porcentaje = scales::comma(Porcentaje, big.mark = ".",decimal.mark = ",",accuracy = 0.01)
  ) %>% filter(CambioClimaticoA != "NA")


CC_ATACAMA %>%
  mutate(MONTO2025 = scales::comma(MONTO2025, big.mark = ".", decimal.mark = ",")) %>% 
  kable(
    "html",
    col.names = c("Cambio Climático", "Inversión 2025", "Porcentaje")) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    font_size = 14
  ) %>% footnote(general = "<span style='font-size: 12px;'>Tabla 15: Desglose de la categoría ‘Otros’ de los proyectos relacionados a Cambio Climático para la región de Atacama. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria.</span>", general_title = "", escape = FALSE)
```


```{r, fig.cap = NULL}


SH_ATACAMA <- BASE %>%
  filter(RegionAB == "ATACAMA") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round((monto2025 / sum(monto2025)) * 100,1)
  )

ggplot(SH_ATACAMA, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
            label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(porcentaje, nsmall = 1, decimal.mark = ","), "%)") ),
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nregión de Atacama",
    x = NULL,
    y = "",
     caption = "Figura 23: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la región de Atacama. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrado, agua potable rural concentrado y \nagua potable rural disperso. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."

  ) +
  theme_minimal() +
  theme(
   panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-36), color = "#555555")
  ) +
  expand_limits(y = c(0, max(SH_ATACAMA$porcentaje) + 5)) +
  scale_y_continuous(labels = scales::percent_format(scale = 1, decimal.mark = ","))



```




## Coquimbo


```{r, fig.cap = NULL}
SERVICIOS_COQ <- BASE %>%
  filter(RegionAB == "COQUIMBO") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DP", "DOP","DGA","DAP","DA") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto2025 / sum(Monto2025) * 100,1))


ggplot(SERVICIOS_COQ , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(Porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la región de Coquimbo",
       x = "",
       y = "Inversión (miles de pesos)",
       caption = "Figura 23: Inversión 2025 para los servicios asociados al MOP para la región de Coquimbo. Fuente: Elaboración propia a \npartir de los datos del Departamento de Gestión Presupuestaria.Nota: La categoría 'Otros' comprende los servicios DP, DOP, \nDGA, DAP y DA."
) +
  scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_COQ$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
        plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555")
)



otros_data_COQUIMBO <- BASE %>%
  filter(RegionAB == "COQUIMBO") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DP", "DOP","DGA","DAP","DA")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_COQUIMBO, "html", col.names = c("Servicio", "Inversión 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%  footnote(general = "<span style='font-size: 12px;'>Tabla 16: Servicios agrupados en 'Otros', los cuáles incluyen DP, DOP, DGA, DAP y DA. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria</span>", general_title = "", escape = FALSE) 

```






```{r, fig.cap = NULL}

tab_eje_ministerial_cat_COQ <- BASE %>%
  filter(RegionAB == "COQUIMBO" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = round(Monto2025 / total_global * 100,2) 
  )



ggplot(tab_eje_ministerial_cat_COQ, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyectos de Arrastre", "Nuevo" = "Proyectos Nuevos"))) +
  labs(
    x = "", 
    y = "Inversión (miles de pesos)", 
    fill = "",
    
title = "Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial \npara la región de Coquimbo", 
caption = "Figura 24: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la región de \nCoquimbo. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."

  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(porcentaje, big.mark = ".", decimal.mark = ","), "%"
)), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
  theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555")) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + 
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )


```

```{r, fig.cap = NULL}
tab_poblacion_Coquimbo <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "COQUIMBO") %>%  
  select(NombreComuna, `Población censada`, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2024" = first(`Población censada`),  
    "Población 2025" = first(`Suma de Poblacion 2025`),  
  "Crec/Decrec relativo de Población 2024 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(`Población censada`)) / first(`Población censada`) * 100, 1), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 1
),

    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))


tab_monto_Coquimbo <-  BASE %>%
  filter(RegionAB == "COQUIMBO") %>%   
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))


tab_resumen_Coquimbo <- left_join(tab_poblacion_Coquimbo,tab_monto_Coquimbo, by = "NombreComuna")




tab_resumen_Coquimbo %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
mutate(`Población 2024` = scales::comma(`Población 2024`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), 
       Monto2025 = ifelse(is.na(Monto2025), "Por definir", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))) %>%
  
  mutate(NombreComuna = case_when(NombreComuna == "COMBARBALA" ~ "COMBARBALÁ", NombreComuna == "PAIGUANO" ~ "PAIHUANO", NombreComuna == "RIO HURTADO" ~ "RÍO HURTADO", TRUE ~ NombreComuna)) %>% 
  
  kable("html", col.names = c("Comuna", "Población 2024", "Población 2025 (*)", "Crec/Decrec relativo (%) de Población 2024 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "<span style='font-size: 12px;'>Tabla 17: Poblaciones e Inversiones 2025 en la región de Coquimbo. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN 2022. (*) Población proyectada al 2025 según el INE. (**) Indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores 'Por definir' en la columna Inversión corresponden a comunas que forman parte de proyectos intercomunales pero que no tienen un monto asociado.</span>", 
         general_title = "", 
         escape = FALSE)



```




```{r, fig.cap = NULL}
CC_NA_OTROS_COQUIMBO <- BASE %>%
  filter(RegionAB == "COQUIMBO") %>%
  mutate(CambioClimaticoA = ifelse(is.na(CambioClimaticoA), "No Aplica", "Otros")) %>%
  group_by(CambioClimaticoA) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round(Monto2025 / sum(Monto2025) * 100, 2),
    porcentaje = scales::comma(porcentaje, big.mark = ".", decimal.mark = ",", accuracy = 0.01),
    etiqueta = paste0(CambioClimaticoA, "\n", porcentaje, "%"),
    leyenda_texto = paste0(CambioClimaticoA, " - ", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))
  )

ggplot(CC_NA_OTROS_COQUIMBO, aes(x = "", y = Monto2025, fill = CambioClimaticoA)) +
  geom_bar(stat = "identity", width = 1, color = "white") + 
  coord_polar("y", start = 0) + 
  geom_text(
    aes(label = etiqueta), 
    position = position_stack(vjust = 0.5), 
    size = 4, 
    color = "black",
    fontface = "bold"
  ) +
  scale_fill_manual(
    values = alpha(c( "#578E7E","cornsilk3"), .7),
    labels = CC_NA_OTROS_COQUIMBO$leyenda_texto
  ) +
  labs(
    title = "Distribución porcentual de Inversión 2025 por categoría de Cambio Climático  \n para la región de Coquimbo",
        caption = "Figura 25: Inversiones 2025 según tipo de proyecto vinculado al Cambio Climático para la región de Coquimbo. \nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' \nincluye a aquellos proyectos pertenecientes a 'Adaptación', 'Mitigación' y 'Mixto, mitigación y adaptación'. ",
    fill = "Categoría"
  ) +
  theme_minimal() +
  theme(
plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-40), color = "#555555"),
    legend.text = element_text(size=10),
    panel.grid = element_blank(), 
    axis.title = element_blank(), 
    axis.text = element_blank(),  
    axis.ticks = element_blank()
  )


```



```{r}
CC_COQUIMBO <- BASE %>%
  filter(RegionAB == "COQUIMBO") %>%
  group_by(CambioClimaticoA) %>%
  summarise(MONTO2025 = sum(`Monto 2025`, na.rm = TRUE)) %>% 
  mutate(
    Porcentaje = round((MONTO2025 / sum(MONTO2025)) * 100,2),
    Porcentaje = scales::comma(Porcentaje, big.mark = ".",decimal.mark = ",",accuracy = 0.01)
  ) %>% filter(CambioClimaticoA != "NA")


CC_COQUIMBO %>%
  mutate(MONTO2025 = scales::comma(MONTO2025, big.mark = ".", decimal.mark = ",")) %>% 
  kable(
    "html",
    col.names = c("Cambio Climático", "Inversión 2025", "Porcentaje")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    font_size = 14
  ) %>% footnote(general = "<span style='font-size: 12px;'>Tabla 18: Desglose de la categoría ‘Otros’ de los proyectos relacionados a Cambio Climático para la región de Coquimbo. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria.</span>", general_title = "", escape = FALSE)

```

```{r, fig.cap = NULL}


SH_COQUIMBO <- BASE %>%
  filter(RegionAB == "COQUIMBO") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round((monto2025 / sum(monto2025)) * 100,1)
  )

ggplot(SH_COQUIMBO, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
            label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(porcentaje, nsmall = 1, decimal.mark = ","), "%)") ),
    fontface = "bold",
    vjust = 1.6,
    size = 3
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en nuevos proyectos del Eje de Seguridad Hídrica para la \nregión de Coquimbo",
    x = NULL,
    caption = "Figura 26: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad \nHídrica para la región de Coquimbo. Fuente: Elaboración propia a partir de datos del Departamento de \nGestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrado, agua potable rural concentrado y \nagua potable rural disperso. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición.",
    y = ""
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85), color = "#555555")
  ) +
  expand_limits(y = c(0, max(SH_COQUIMBO$porcentaje) + 5))+
  scale_y_continuous(labels = scales::percent_format(scale = 1, decimal.mark = ","))



```







## Valparaíso



```{r, fig.cap=NULL}
SERVICIOS_VALPO <- BASE %>%
  filter(RegionAB == "VALPARAÍSO") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DP", "DA") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto2025 / sum(Monto2025) * 100,2))


ggplot(SERVICIOS_VALPO , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(Porcentaje, nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la región de Valparaíso",
       x = "",
       y = "Inversión (miles de pesos)",
       caption = "Figura 27: Inversión 2025 para los servicios asociados al MOP para la región de Valparaíso. Fuente: Elaboración propia a \npartir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DA y DP") +
  scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_VALPO$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
         plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-40), color = "#555555"))



otros_data_VALPO <- BASE %>%
  filter(RegionAB == "VALPARAÍSO") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto / sum(Monto) * 100,3)) %>% 
  filter(Servicio %in% c("DP", "DA")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(Porcentaje, big.mark = ".", decimal.mark = ",", accuracy = 0.0001)
  )



kable(otros_data_VALPO, "html", col.names = c("Servicio", "Inversión 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
    footnote(general = "<span style='font-size: 12px;'>Tabla 19: Servicios agrupados en ‘Otros’, los cuáles incluyen DA y DP para la región de Valparaíso. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.</span>", general_title = "", escape = FALSE)

```






```{r, fig.cap=NULL}

tab_eje_ministerial_cat_VALPO <- BASE %>%
  filter(RegionAB == "VALPARAÍSO" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = round(Monto2025 / total_global * 100,2) 
  )




ggplot(tab_eje_ministerial_cat_VALPO, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyectos de Arrastre", "Nuevo" = "Proyectos Nuevos"))) +
  labs(
    x = "", 
    y = "Inversión (miles de pesos)", 
    fill = "",
    title = "Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial para la \nregión de Valparaíso",
    caption = "Figura 28: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales \npara la región de Valparaíso. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."

  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(porcentaje, big.mark = ".", decimal.mark = ","), "%"
)
), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
  theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555"))  +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + 
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )



```

```{r}



tab_poblacion_Valparaiso <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "VALPARAÍSO") %>%  
 select(NombreComuna, `Población censada`, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
summarise(
    "Población 2024" = sum(`Población censada`), 
    "Población 2025" = sum(`Suma de Poblacion 2025`), 
   "Crec/Decrec relativo de Población 2024 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(`Población censada`)) / first(`Población censada`) * 100, 2), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 2
),
    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))


tab_monto_Valparaiso <- BASE %>%
  filter(RegionAB == "VALPARAÍSO") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))

tab_resumen_Valparaiso <- left_join(tab_poblacion_Valparaiso,tab_monto_Valparaiso, by = "NombreComuna")

tab_resumen_Valparaiso %>% 
mutate(`Población 2024` = scales::comma(`Población 2024`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), 
       Monto2025 = ifelse(is.na(Monto2025), "Por definir", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))) %>%
  
    mutate(NombreComuna = case_when(NombreComuna == "CONCON" ~ "CONCÓN", NombreComuna == "JUAN FERNANDEZ" ~ "JUAN FERNÁNDEZ", NombreComuna == " OLMUE" ~ "OLMUÉ", NombreComuna == "PUCHUNCAVI" ~ "PUCHUNCAVÍ",
                                  NombreComuna == "QUILPUE" ~ "QUILPUÉ", NombreComuna == "SANTA MARIA" ~ "SANTA MARÍA",
                                  NombreComuna == "VALPARAISO" ~ "VALPARAÍSO", TRUE ~ NombreComuna)) %>% 
  
  kable("html", col.names = c("Comuna", "Población 2024", "Población 2025 (*)", "Crec/Decrec relativo (%) de Población 2024 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión")) %>%

  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "<span style='font-size: 12px;'>Tabla 20: Poblaciones e Inversiones 2025 en la región de Valparaíso. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN 2022. (*) Población proyectada al 2025 según el INE. (**) Indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores 'Por definir' en la columna Inversión corresponden a comunas que forman parte de proyectos intercomunales pero que no tienen un monto asociado.</span>", 
         general_title = "", 
         escape = FALSE)



```



```{r, fig.cap = NULL}
CC_NA_OTROS_VALPO <- BASE %>%
  filter(RegionAB == "VALPARAÍSO") %>%
  mutate(CambioClimaticoA = ifelse(is.na(CambioClimaticoA), "No Aplica", "Otros")) %>%
  group_by(CambioClimaticoA) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round(Monto2025 / sum(Monto2025) * 100, 2),
    porcentaje = scales::comma(porcentaje, big.mark = ".", decimal.mark = ",", accuracy = 0.01),
    etiqueta = paste0(CambioClimaticoA, "\n", porcentaje, "%"),
    leyenda_texto = paste0(CambioClimaticoA, " - ", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))
  )

ggplot(CC_NA_OTROS_VALPO, aes(x = "", y = Monto2025, fill = CambioClimaticoA)) +
  geom_bar(stat = "identity", width = 1, color = "white") + 
  coord_polar("y", start = 0) + 
  geom_text(
    aes(label = etiqueta), 
    position = position_stack(vjust = 0.5), 
    size = 4, 
    color = "black",
    fontface = "bold"
  ) +
  scale_fill_manual(
    values = alpha(c( "#578E7E","cornsilk3"), .7),
    labels = CC_NA_OTROS_VALPO$leyenda_texto
  ) +
  labs(
    title = "Distribución porcentual de Inversión 2025 por categoría de Cambio Climático  \n para la región de Valparaíso",
    fill = "Categoría",
         caption =  "Figura 29: Inversión 2025 según tipo de proyecto vinculado al Cambio Climático para la región de Valparaíso. \nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría \n'Otros' incluye a aquellos proyectos pertenecientes a 'Adaptación' 'Mitigación' y 'Mixto, mitigación y adaptación'. "

  ) +
  theme_minimal() +
  theme(
legend.text = element_text(size=10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0, margin = margin(b = 20)),
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555"),
    panel.grid = element_blank(), 
    axis.title = element_blank(), 
    axis.text = element_blank(),  
    axis.ticks = element_blank()

  )


```


```{r}
CC_VALPO <- BASE %>%
    filter(RegionAB == "VALPARAÍSO") %>%
  group_by(CambioClimaticoA) %>%
  summarise(MONTO2025 = sum(`Monto 2025`, na.rm = TRUE)) %>% 
  mutate(
    Porcentaje = round((MONTO2025 / sum(MONTO2025)) * 100,2),
    Porcentaje = scales::comma(Porcentaje, big.mark = ".",decimal.mark = ",",accuracy = 0.01)
  ) %>% filter(CambioClimaticoA != "NA")


CC_VALPO %>%
  mutate(MONTO2025 = scales::comma(MONTO2025, big.mark = ".", decimal.mark = ",")) %>% 
  kable(
    "html",
    col.names = c("Cambio Climático", "Inversión 2025", "Porcentaje")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    font_size = 14
  )%>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 21: Desglose de la categoría 'Otros' de los proyectos relacionados a Cambio Climático para la región de Valparaíso. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria</span>", escape = FALSE, general_title = "")

```

```{r, fig.cap = NULL}


SH_VALPO <- BASE %>%
  filter(RegionAB == "VALPARAÍSO") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round((monto2025 / sum(monto2025)) * 100,2)
  )

ggplot(SH_VALPO, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
            label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(porcentaje, nsmall = 1, decimal.mark = ","), "%)") ),
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nregión de Valparaíso",
    x = NULL,
    y = "",
    caption = "Figura 30: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al eje ministerial de Seguridad Hídrica \npara la región de Valparaíso. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrado, agua potable rural concentrado y \nagua potable rural disperso. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."
    
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85), color = "#555555")
  ) +
  expand_limits(y = c(0, max(SH_VALPO$porcentaje) + 5))+
  scale_y_continuous(labels = scales::percent_format(scale = 1, decimal.mark = ","))



```



## Metropolitana de Santiago




```{r, fig.cap = NULL}
SERVICIOS_RM <- BASE %>%
  filter(RegionAB == "METROPOLITANA") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DP", "DGA","INH","SISS","DAP") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto2025 / sum(Monto2025) * 100,2))


ggplot(SERVICIOS_RM , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(Porcentaje, nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la \nregión Metropolitana de Santiago",
       x = "",
       y = "Inversión (miles de pesos)",
       caption = "Figura 31: Inversión 2025 para los servicios asociados al MOP para la región Metropolitana de Santiago. Fuente: Elaboración propia a \npartir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DAP, \nDGA, DP, INH y SISS ") +
    scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_RM$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
      plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555")


)



otros_data_RM <- BASE %>%
  filter(RegionAB == "METROPOLITANA") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DP", "DGA","INH","SISS","DAP")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_RM, "html", col.names = c("Servicio", "Inversión 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 22: Servicios agrupados en ‘Otros’, los cuáles incluyen DAP, DGA, DP, INH y SISS para la región Metropolitana de Santiago. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.</span>", general_title = "", escape = FALSE)


```




```{r, fig.cap=NULL}

tab_eje_ministerial_cat_RM <- BASE %>%
  filter(RegionAB == "METROPOLITANA" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = round(Monto2025 / total_global * 100,2)
  )


ggplot(tab_eje_ministerial_cat_RM, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyectos de Arrastre", "Nuevo" = "Proyectos Nuevos"))) +
  labs(
    x = "", 
    y = "Inversión (miles de pesos)", 
    fill = "",
    title = "Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial \npara la región Metropolitana de Santiago",     
caption = "Figura 32: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la Región \nMetropolitana de Santiago. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."
  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(porcentaje, big.mark = ".", decimal.mark = ","), "%"
)), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
 theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555")) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + # Divide la leyenda en 2 filas
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )



```

```{r}

PROYECCIONES_POBmulti <- PROYECCIONES_POBmulti %>% mutate(NombreComuna = case_when(NombreComuna == "TILTIL" ~ "TIL TIL", TRUE ~ NombreComuna))


tab_poblacion_Metropolitana <- PROYECCIONES_POBmulti %>%
  filter(RegionAB=="METROPOLITANA") %>%  
  select(NombreComuna, `Población censada`, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2024" = first(`Población censada`),  
    "Población 2025" = first(`Suma de Poblacion 2025`),  
   "Crec/Decrec relativo de Población 2024 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(`Población censada`)) / first(`Población censada`) * 100, 2), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 1
),
"Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))


tab_monto_RM <- BASE %>%
  filter(RegionAB == "METROPOLITANA") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))


tab_resumen_RM <- left_join(tab_poblacion_Metropolitana,tab_monto_RM, by = "NombreComuna")


tab_resumen_RM <- tab_resumen_RM %>%
  mutate(
    Monto2025 = case_when(
      NombreComuna == "Pirque" ~ 0, 
      TRUE ~ Monto2025        
    )
  )





tab_resumen_RM %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
    mutate(Monto2025 = case_when(NombreComuna == "CALERA DE TANGO" ~ 0,
                               NombreComuna == "PIRQUE" ~ 0,
                               TRUE ~ Monto2025)) |> 
  
mutate(`Población 2024` = scales::comma(`Población 2024`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), 
       Monto2025 = ifelse(is.na(Monto2025), "Por definir", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))) %>%
  
mutate(NombreComuna = case_when(NombreComuna == "ALHUE" ~ "ALHUÉ",
                        NombreComuna == "CONCHALI" ~ "CONCHALÍ",
                        NombreComuna == "CURACAVI" ~ "CURACAVÍ",
            NombreComuna == "ESTACION CENTRAL" ~ "ESTACIÓN CENTRAL",
            NombreComuna == "MACUL" ~ "MACÚL",
            NombreComuna == "MAIPU" ~ "MAIPÚ",
            NombreComuna == "MARIA PINTO" ~ "MARÍA PINTO",
            NombreComuna == "PEÑALOLEN" ~ "PEÑALOLÉN",
            NombreComuna == "SAN JOAQUIN" ~ "SAN JOAQUÍN",
            NombreComuna == "SAN JOSE DE MAIPO" ~ "SAN JOSÉ DE MAIPO",
            NombreComuna == "SAN RAMON" ~ "SAN RAMÓN",
            TRUE ~ NombreComuna)) |> 
  
  kable("html", col.names = c("Comuna", "Población 2024", "Población 2025 (*)", "Crec/Decrec relativo (%) de Población 2024 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "<span style='font-size: 12px;'>Tabla 23: Poblaciones e Inversiones 2025 en la región Metropolitana de Santiago. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN. (*) Población 
proyectada al 2025 según el INE. (**) Indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores 'Por definir' en la columna Inversión corresponden a comunas que forman parte de proyectos intercomunales pero que no tienen un monto asociado.</span>", general_title = "", escape = FALSE)







```


```{r, fig.cap = NULL}
CC_NA_OTROS_RM <- BASE %>%
  filter(RegionAB == "METROPOLITANA") %>%
  mutate(CambioClimaticoA = ifelse(is.na(CambioClimaticoA), "No Aplica", "Otros")) %>%
  group_by(CambioClimaticoA) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(porcentaje = round(Monto2025 / sum(Monto2025) * 100, 2),
    porcentaje = scales::comma(porcentaje, big.mark = ".", decimal.mark = ",", accuracy = 0.01),
    etiqueta = paste0(CambioClimaticoA, "\n", porcentaje, "%"),
    leyenda_texto = paste0(CambioClimaticoA, " - ", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))
  )

ggplot(CC_NA_OTROS_RM, aes(x = "", y = Monto2025, fill = CambioClimaticoA)) +
  geom_bar(stat = "identity", width = 1, color = "white") + 
  coord_polar("y", start = 0) + 
  geom_text(
    aes(label = etiqueta), 
    position = position_stack(vjust = 0.5), 
    size = 4, 
    color = "black",
    fontface = "bold"
  ) +
  scale_fill_manual(
    values = alpha(c( "#578E7E","cornsilk3"), .7),
    labels = CC_NA_OTROS_RM$leyenda_texto
  ) +
  labs(
    title = "Distribución porcentual de Inversión 2025 por categoría de Cambio Climático  \n para la región Metropolitana de Santiago",    
    caption = "Figura 33: Inversiones 2025 según tipo de proyecto vinculado al Cambio Climático para la región Metropolitana de Santiago. \nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' \nincluye a aquellos proyectos pertenecientes a 'Adaptación', 'Mitigación' y 'Mixto, mitigación y adaptación'.",
    fill = "Categoría"
  ) +
  theme_minimal() +
  theme(
     legend.text = element_text(size=10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0, margin = margin(b = 20)),
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-47), color = "#555555"),
    panel.grid = element_blank(), 
    axis.title = element_blank(), 
    axis.text = element_blank(),  
    axis.ticks = element_blank()
  )


```



```{r, fig.cap = NULL}
CC_RM <- BASE %>%
  group_by(CambioClimaticoA) %>%
  filter(RegionAB == "METROPOLITANA") %>%
  summarise(MONTO2025 = sum(`Monto 2025`, na.rm = TRUE)) %>% 
  mutate(
    Porcentaje = round((MONTO2025 / sum(MONTO2025)) * 100,2),
    Porcentaje = scales::comma(Porcentaje, big.mark = ".",decimal.mark = ",",accuracy = 0.01)
  ) %>% filter(CambioClimaticoA != "NA")


CC_RM %>%
  mutate(MONTO2025 = scales::comma(MONTO2025, big.mark = ".", decimal.mark = ",")) %>% 
  kable(
    "html",
    col.names = c("Cambio Climático", "Inversión 2025", "Porcentaje")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    font_size = 14
  )%>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 24: Desglose de la categoría 'Otros' de los proyectos relacionados a Cambio Climático para la región Metropolitana de Santiago. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria</span>", escape = FALSE, general_title = "")

```



```{r, fig.cap = NULL}


SH_RM <- BASE %>%
  filter(RegionAB == "METROPOLITANA") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round((monto2025 / sum(monto2025)) * 100,1)
  )

ggplot(SH_RM, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)") )
    ,
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en nuevos proyectos del Eje de Seguridad Hídrica para la \nregión Metropolitana de Santiago",
    x = NULL,
    y = "",
    caption = "Figura 34: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la región Metropolitana de Santiago. Fuente: Elaboración propia a partir de datos del Departamento de Gestión \nPresupuestaria. Nota: La categorización del programa dipres fue realizada en cuatro clases. \nLa primera es 'Consumo Humano' que está compuesta por los programas pertenecientes a: agua potable rural \nsemi-concentrado, agua potable rural concentrado y agua potable rural disperso. La segunda es 'Riego' que agrupa: \ngrandes obras de riego, conservación de obras de riego, explotación de obras de riego y obras de riego. La categoría \n'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, estudio y otros. Finalmente, la \ncategoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de recursos hídricos y ampliación de \nredes de medición."
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85), color = "#555555")
  ) +
  expand_limits(y = c(0, max(SH_RM$porcentaje) + 5))+
  scale_y_continuous(labels = scales::percent_format(scale = 1, decimal.mark = ","))



```



## Libertador del General Bernardo O'higgins
 

```{r, fig.cap = NULL}
SERVICIOS_LGBO <- BASE %>%
  filter(RegionAB == "O'HIGGINS") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DAP", "DA","DGA","DOP","DP") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto2025 / sum(Monto2025) * 100,3))



ggplot(SERVICIOS_LGBO , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(Porcentaje, nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la región de O'Higgins",
       x = "",
       y = "Inversión (miles de pesos)",
       caption = "Figura 35: Inversión 2025 para los servicios asociados al MOP para la región de O'Higgins. Fuente: Elaboración propia a \npartir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DA, DAP, \nDGA, DOP y DP") +
  scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_LGBO$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
         plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555"))



otros_data_LGBO <- BASE %>%
  filter(RegionAB == "O'HIGGINS") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DAP", "DA","DGA","DOP","DP")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_LGBO, "html", col.names = c("Servicio", "Inversión 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 25: Servicios agrupados en ‘Otros’, los cuáles incluyen DA, DAP, DGA, DOP y DP para la región de O'Higgins. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.</span>", general_title = "",  escape = FALSE)


```




```{r, fig.cap = NULL}

tab_eje_ministerial_cat_LGBO <- BASE %>%
  filter(RegionAB == "O'HIGGINS" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = round(Monto2025 / total_global * 100,3) 
  )




ggplot(tab_eje_ministerial_cat_LGBO, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyectos de Arrastre", "Nuevo" = "Proyectos Nuevos"))) +
  labs(
  x = "", 
    y = "Inversión (miles de pesos)", 
    fill = "",
    title = "Inversión 2025 por Clasificación del Proyecto (Arrastre y Nuevo)\n y Eje Ministerial para la región de O'Higgins",
    caption = "Figura 36: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la región de \nO'Higgins. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."
  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(porcentaje, big.mark = ".", decimal.mark = ","), "%"
)
), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
  theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555"))  +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + # Divide la leyenda en 2 filas
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )


```

```{r}


tab_poblacion_OHiggins <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "O'HIGGINS") %>% 
  select(NombreComuna, `Población censada`, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2024" = first(`Población censada`),  
    "Población 2025" = first(`Suma de Poblacion 2025`),  
 "Crec/Decrec relativo de Población 2024 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(`Población censada`)) / first(`Población censada`) * 100, 1), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 1
),

    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))



tab_monto_Ohiggins <- BASE %>%
  filter(RegionAB == "O'HIGGINS") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))



tab_resumen_LGBO <- left_join(tab_poblacion_OHiggins,tab_monto_Ohiggins, by = "NombreComuna")




tab_resumen_LGBO %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
mutate(`Población 2024` = scales::comma(`Población 2024`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), 
       Monto2025 = ifelse(is.na(Monto2025), "Por definir", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))) %>%
mutate(NombreComuna = case_when(NombreComuna == "MACHALI" ~ "MACHALÍ",
                                NombreComuna == "CHEPICA" ~ "CHÉPICA",
                                NombreComuna == "REQUINOA" ~ "REQUÍNOA", TRUE ~ NombreComuna)) %>% 
  kable("html", col.names = c("Comuna", "Población 2024", "Población 2025 (*)", "Crec/Decrec relativo (%) de Población 2024 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
footnote(
  general = "<span style='font-size: 12px;'>Tabla 26: Poblaciones e Inversiones 2025 en la región del Libertador Bernardo O'Higgins. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN 2022. (*) Población proyectada al 2025 según el INE. (**) Indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores 'Por definir' en la columna Inversión corresponden a comunas que forman parte de proyectos intercomunales pero que no tienen un monto asociado.</span>",
  general_title = "",
  escape = FALSE
)




```



```{r, fig.cap = NULL}
CC_NA_OTROS_LGBO <- BASE %>%
  filter(RegionAB == "O'HIGGINS") %>%
  mutate(CambioClimaticoA = ifelse(is.na(CambioClimaticoA), "No Aplica", "Otros")) %>%
  group_by(CambioClimaticoA) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(porcentaje = round(Monto2025 / sum(Monto2025) * 100, 2),
    porcentaje = scales::comma(porcentaje, big.mark = ".", decimal.mark = ",", accuracy = 0.01),
    etiqueta = paste0(CambioClimaticoA, "\n", porcentaje, "%"),
    leyenda_texto = paste0(CambioClimaticoA, " - ", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))
  )

ggplot(CC_NA_OTROS_LGBO, aes(x = "", y = Monto2025, fill = CambioClimaticoA)) +
  geom_bar(stat = "identity", width = 1, color = "white") + 
  coord_polar("y", start = 0) + 
  geom_text(
    aes(label = etiqueta), 
    position = position_stack(vjust = 0.5), 
    size = 4, 
    color = "black",
    fontface = "bold"
  ) +
  scale_fill_manual(
    values = alpha(c( "#578E7E","cornsilk3"), .7),
    labels = CC_NA_OTROS_LGBO$leyenda_texto
  ) +
  labs(
    title = "Distribución porcentual de Inversión 2025 por categoría de Cambio Climático  \n para la región de O'Higgins",
    fill = "Categoría",
  caption =  "Figura 37: Inversión 2025 según tipo de proyecto vinculado al Cambio Climático para la región de O'Higgins. \nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría \n'Otros' incluye a aquellos proyectos pertenecientes a 'Adaptación' 'Mitigación' y 'Mixto, mitigación y adaptación'. "

  ) +
  theme_minimal() +
  theme(
 legend.text = element_text(size=10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0, margin = margin(b = 20)),
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-47), color = "#555555"),
    panel.grid = element_blank(), 
    axis.title = element_blank(), 
    axis.text = element_blank(),  
    axis.ticks = element_blank()

  )


```


```{r}
CC_LGBO <- BASE %>%
  group_by(CambioClimaticoA) %>%
  filter(RegionAB == "O'HIGGINS") %>%
  summarise(MONTO2025 = sum(`Monto 2025`, na.rm = TRUE)) %>% 
  mutate(
    Porcentaje = round((MONTO2025 / sum(MONTO2025)) * 100,2),
    Porcentaje = scales::comma(Porcentaje, big.mark = ".",decimal.mark = ",",accuracy = 0.01)
  ) %>% filter(CambioClimaticoA != "NA")


CC_LGBO %>%
  mutate(MONTO2025 = scales::comma(MONTO2025, big.mark = ".", decimal.mark = ",")) %>% 
  kable(
    "html",
    col.names = c("Cambio Climático", "Inversión 2025", "Porcentaje")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    font_size = 14
  )%>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 27: Desglose de la categoría 'Otros' de los proyectos relacionados a Cambio Climático para la región de O'Higgins. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria<span>", escape = FALSE, general_title = "")

```




```{r, fig.cap = NULL}


SH_LGBO <- BASE %>%
  filter(RegionAB == "O'HIGGINS") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round((monto2025 / sum(monto2025)) * 100,2)
  )

ggplot(SH_LGBO, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(porcentaje, nsmall = 1, decimal.mark = ","), "%)") ),
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nregión de O'Higgins",
    x = NULL,
    y = "",
    caption = "Figura 38: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la región de O'Higgins. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrado, agua potable rural concentrado y \nagua potable rural disperso. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85), color = "#555555")
  ) +
  expand_limits(y = c(0, max(SH_LGBO$porcentaje) + 5))+
  scale_y_continuous(labels = scales::percent_format(scale = 1, decimal.mark = ","))



```




## Maule





```{r, fig.cap = NULL}
SERVICIOS_MAULE <- BASE %>%
  filter(RegionAB == "MAULE") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DA", "DGA","DGC") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto2025 / sum(Monto2025) * 100,1))


ggplot(SERVICIOS_MAULE , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(Porcentaje,3), nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la región del Maule",
y = "Inversión (miles de pesos)",
       caption = "Figura 39: Inversión 2025 para los servicios asociados al MOP de la región del Maule. Fuente: Elaboración propia a  \npartir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DA, \nDGA y DGC.",
       x = "") +
    scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_MAULE$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        
panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
        plot.caption = element_text(size = 9, hjust = -0.2, margin = margin(t = 10, r = 100, b = 5, l=-48), color = "#555555"))



otros_data_MAULE <- BASE %>%
  filter(RegionAB == "MAULE") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DA", "DGA","DGC")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_MAULE, "html", col.names = c("Servicio", "Inversión 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 28: Servicios agrupados en ‘Otros’, los cuáles incluyen DA, DGA y DGC para la región deL Maule. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.</span>", general_title = "", escape=FALSE)


```



```{r, fig.cap = NULL}

tab_eje_ministerial_cat_MAULE <- BASE %>%
  filter(RegionAB == "MAULE" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = round(Monto2025 / total_global * 100,3) 
  )





ggplot(tab_eje_ministerial_cat_MAULE, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyectos de Arrastre", "Nuevo" = "Proyectos Nuevos"))) +
  labs(
    title = "Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial \npara la región del Maule",  
    x = "", 
    y = "Inversión (miles de pesos)", 
    fill = "",
    caption = "Figura 40: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la región \ndel Maule. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria.") + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(porcentaje, big.mark = ".", decimal.mark = ","), "%"
)), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
  theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555"))  +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + # Divide la leyenda en 2 filas
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )



```

```{r}



tab_poblacion_Maule <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "MAULE") %>%  
  select(NombreComuna, `Población censada`, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2024" = first(`Población censada`), 
    "Población 2025" = first(`Suma de Poblacion 2025`),  
    "Crec/Decrec relativo de Población 2024 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(`Población censada`)) / first(`Población censada`) * 100, 1), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 1
),
 
    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))



tab_monto_Maule <- BASE %>%
  filter(RegionAB == "MAULE") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))



tab_resumen_maule <- left_join(tab_poblacion_Maule,tab_monto_Maule, by = "NombreComuna")




tab_resumen_maule %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
mutate(`Población 2024` = scales::comma(`Población 2024`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), 
       Monto2025 = ifelse(is.na(Monto2025), "Por definir", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))) %>%
  mutate(NombreComuna = case_when(NombreComuna == "COLBUN" ~ "COLBÚN",
                NombreComuna == "CONSTITUCION" ~ "CONSTITUCIÓN",
                NombreComuna == "CURICO" ~ "CURICÓ",
                NombreComuna == "HUALAÑE" ~ "HUALAÑÉ",
                NombreComuna == "LICANTEN" ~ "LICANTÉN",
                NombreComuna == "LONGAVI" ~ "LONGAVÍ",
                NombreComuna == "RIO CLARO" ~ "RÍO CLARO",
                NombreComuna == "VICHUQUEN" ~ "VICHUQUÉN",
                TRUE ~ NombreComuna)) %>% 
  kable("html", col.names = c("Comuna", "Población 2024", "Población 2025 (*)", "Crec/Decrec relativo (%) de Población 2024 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "<span style='font-size: 12px;'>Tabla 29: Poblaciones e Inversiones 2025 en la región del Maule. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN. (*) Población 
proyectada al 2025 según el INE. (**) Indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores NA en la columna Inversión 2025 corresponden a comunas que forman parte de proyectos intercomunales.</span>", 
         general_title = "", 
         escape = FALSE)






```






```{r, fig.cap = NULL}
CC_NA_OTROS_MAULE <- BASE %>%
  filter(RegionAB == "MAULE") %>%
  mutate(CambioClimaticoA = ifelse(is.na(CambioClimaticoA), "No Aplica", "Otros")) %>%
  group_by(CambioClimaticoA) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(porcentaje = round(Monto2025 / sum(Monto2025) * 100, 2),
    porcentaje = scales::comma(porcentaje, big.mark = ".", decimal.mark = ",", accuracy = 0.01),
    etiqueta = paste0(CambioClimaticoA, "\n", porcentaje, "%"),
    leyenda_texto = paste0(CambioClimaticoA, " - ", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))
  )

ggplot(CC_NA_OTROS_MAULE, aes(x = "", y = Monto2025, fill = CambioClimaticoA)) +
  geom_bar(stat = "identity", width = 1, color = "white") + 
  coord_polar("y", start = 0) + 
  geom_text(
    aes(label = etiqueta), 
    position = position_stack(vjust = 0.5), 
    size = 4, 
    color = "black",
    fontface = "bold"
  ) +
  scale_fill_manual(
    values = alpha(c( "#578E7E","cornsilk3"), .7),
    labels = CC_NA_OTROS_MAULE$leyenda_texto
  ) +
  labs(
    title = "Distribución porcentual de Inversión 2025 por categoría de Cambio Climático \n para la región del Maule",
caption = "Figura 41: Inversiones 2025 según tipo de proyecto vinculado al Cambio Climático para la región del Maule. \nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' \nincluye a aquellos proyectos pertenecientes a 'Adaptación', 'Mitigación' y 'Mixto, mitigación y adaptación'. ",
    fill = "Categoría"
  ) +
  theme_minimal() +
  theme(
    legend.text = element_text(size=10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0, margin = margin(b = 20)),
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-43), color = "#555555"),
    panel.grid = element_blank(), 
    axis.title = element_blank(), 
    axis.text = element_blank(),  
    axis.ticks = element_blank()

  )


```




```{r}
CC_MAULE <- BASE %>%
  group_by(CambioClimaticoA) %>%
  filter(RegionAB == "MAULE") %>%
  summarise(MONTO2025 = sum(`Monto 2025`, na.rm = TRUE)) %>% 
  mutate(
    Porcentaje = round((MONTO2025 / sum(MONTO2025)) * 100,2),
    Porcentaje = scales::comma(Porcentaje, big.mark = ".",decimal.mark = ",",accuracy = 0.01)
  ) %>% filter(CambioClimaticoA != "NA")


CC_MAULE %>%
  mutate(MONTO2025 = scales::comma(MONTO2025, big.mark = ".", decimal.mark = ",")) %>% 
  kable(
    "html",
    col.names = c("Cambio Climático", "Inversión 2025", "Porcentaje")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    font_size = 14
  )%>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 30: Desglose de la categoría 'Otros' de los proyectos relacionados a Cambio Climático para la región deL Maule. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria</span>", escape = FALSE, general_title = "")

```





```{r, fig.cap = NULL}


SH_MAULE <- BASE %>%
  filter(RegionAB == "MAULE") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round((monto2025 / sum(monto2025)) * 100,2)
  )

ggplot(SH_MAULE, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(porcentaje, nsmall = 1, decimal.mark = ","), "%)")
    ),
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica\n para la región del Maule",
    x = NULL,
    y = "",
    caption = "Figura 42: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la región del Maule. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentradao, agua potable rural concentrado y \nagua potable rural disperso. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."

  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85), color = "#555555")

  ) +
  expand_limits(y = c(0, max(SH_MAULE$porcentaje) + 5))+
  scale_y_continuous(labels = scales::percent_format(scale = 1, decimal.mark = ","))




```





## Ñuble


```{r, fig.cap = NULL}
SERVICIOS_NUBLE <- BASE %>%
  filter(RegionAB == "ÑUBLE") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DA", "DAP","DOP","DGC") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto2025 / sum(Monto2025) * 100,2))


ggplot(SERVICIOS_NUBLE , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(Porcentaje, nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la región del Ñuble",
       x = "",
       y = "Inversión (miles de pesos)",
       caption = "Figura 43: Inversión 2025 para los servicios asociados al MOP par la región del Ñuble. Fuente: Elaboración propia a partir de los datos del \n Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DA, DAP, DOP y DGC.") +
    scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_NUBLE$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
 plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555")

)



otros_data_NUBLE <- BASE %>%
  filter(RegionAB == "ÑUBLE") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DA", "DAP","DOP","DGC") ) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_NUBLE, "html", col.names = c("Servicio", "Inversión 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 31: Servicios agrupados en ‘Otros’, los cuáles incluyen DA, DAP y DOP y DGC para la región del Ñuble. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.</span>", general_title = "", escape = FALSE)


```




```{r, fig.cap = NULL}

tab_eje_ministerial_cat_NUBLE <- BASE %>%
  filter(RegionAB == "ÑUBLE" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = round(Monto2025 / total_global * 100,2)
  )


ggplot(tab_eje_ministerial_cat_NUBLE, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyectos de Arrastre", "Nuevo" = "Proyectos Nuevos"))) +
  labs(title = "Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial \npara la región del Ñuble",     
    x = "", 
    y = "Inversión (miles de pesos)", 
    fill = "",
    caption = "Figura 44: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la región del \nÑuble. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."

  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje, 2), big.mark = ".", decimal.mark = ","), "%"
)
), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
  theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555")) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + 
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )



```

```{r}



tab_poblacion_Nuble <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "ÑUBLE") %>%  
  select(NombreComuna, `Población censada`, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2024" = first(`Población censada`),  
    "Población 2025" = first(`Suma de Poblacion 2025`),  
 "Crec/Decrec relativo de Población 2024 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(`Población censada`)) / first(`Población censada`) * 100, 1), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 1
),

    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))



tab_monto_NUBLE <- BASE %>%
  filter(RegionAB == "ÑUBLE") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))


tab_resumen_NUBLE <- left_join(tab_poblacion_Nuble,tab_monto_NUBLE, by = "NombreComuna")
  




tab_resumen_NUBLE %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
mutate(`Población 2024` = scales::comma(`Población 2024`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), 
       Monto2025 = ifelse(is.na(Monto2025), "Por definir", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))) %>%
  
  mutate(NombreComuna = case_when(
    NombreComuna == "CHILLAN" ~ "CHILLÁN",
         NombreComuna == "CHILLAN VIEJO" ~ "CHILLÁN VIEJO",
    NombreComuna == "QUILLON" ~ "QUILLÓN",
    NombreComuna == "RANQUIL" ~ "RÁNQUIL",
    NombreComuna == "SAN FABIAN" ~ "SAN FABIÁN",
    NombreComuna == "SAN NICOLAS" ~ "SAN NICOLÁS",
    NombreComuna == "ÑIQUEN" ~ "ÑIQUÉN",
    TRUE ~ NombreComuna)) %>% 
  
  kable("html", col.names = c("Comuna", "Población 2024", "Población 2025 (*)", "Crec/Decrec relativo (%) de Población 2024 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "<span style='font-size: 12px;'>Tabla 32: Poblaciones e Inversiones 2025 en la región del Ñuble. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN. (*) Población 
proyectada al 2025 según el INE. (**) Indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores NA en la columna Inversión 2025 corresponden a comunas que forman parte de proyectos intercomunales.</span>", 
         general_title = "", 
         escape = FALSE)




```



```{r, fig.cap = NULL}
CC_NA_OTROS_NUBLE <- BASE %>%
  filter(RegionAB == "ÑUBLE") %>%
  mutate(CambioClimaticoA = ifelse(is.na(CambioClimaticoA), "No Aplica", "Otros")) %>%
  group_by(CambioClimaticoA) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round(Monto2025 / sum(Monto2025) * 100, 2),
    porcentaje = scales::comma(porcentaje, big.mark = ".", decimal.mark = ",", accuracy = 0.01),
    etiqueta = paste0(CambioClimaticoA, "\n", porcentaje, "%"),
    leyenda_texto = paste0(CambioClimaticoA, " - ", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))
  )

ggplot(CC_NA_OTROS_NUBLE, aes(x = "", y = Monto2025, fill = CambioClimaticoA)) +
  geom_bar(stat = "identity", width = 1, color = "white") + 
  coord_polar("y", start = 0) + 
  geom_text(
    aes(label = etiqueta), 
    position = position_stack(vjust = 0.5), 
    size = 4, 
    color = "black",
    fontface = "bold"
  ) +
  scale_fill_manual(
    values = alpha(c( "#578E7E","cornsilk3"), .7),
    labels = CC_NA_OTROS_NUBLE$leyenda_texto
  ) +
  labs(
    title = "Distribución porcentual de Inversión 2025 por categoría de Cambio Climático  \n para la región del Ñuble",
    caption = "Figura 45: Inversiones 2025 según tipo de proyecto vinculado al Cambio Climático para la región del Ñuble. \nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' \nincluye a aquellos proyectos pertenecientes a 'Adaptación', 'Mitigación' y 'Mixto, mitigación y adaptación'. ",
    fill = "Categoría"
  ) +
  theme_minimal() +
  theme(
   legend.text = element_text(size=10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0, margin = margin(b = 20)),
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-43), color = "#555555"),
    panel.grid = element_blank(), 
    axis.title = element_blank(), 
    axis.text = element_blank(),  
    axis.ticks = element_blank()
  )


```



```{r}
CC_NUBLE <- BASE %>%
    filter(RegionAB == "ÑUBLE") %>%
  group_by(CambioClimaticoA) %>%
  summarise(MONTO2025 = sum(`Monto 2025`, na.rm = TRUE)) %>% 
  mutate(
    Porcentaje = round((MONTO2025 / sum(MONTO2025)) * 100,2),
    Porcentaje = scales::comma(Porcentaje, big.mark = ".",decimal.mark = ",",accuracy = 0.01)
  ) %>% filter(CambioClimaticoA != "NA")


CC_NUBLE %>%
  mutate(MONTO2025 = scales::comma(MONTO2025, big.mark = ".", decimal.mark = ",")) %>% 
  kable(
    "html",
    col.names = c("Cambio Climático", "Inversión 2025", "Porcentaje")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    font_size = 14
  )%>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 32: Desglose de la categoría 'Otros' de los proyectos relacionados a Cambio Climático para la región del Ñuble. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria</span>", escape = FALSE, general_title = "")
```




```{r, fig.cap = NULL}


SH_NUBLE <- BASE %>%
  filter(RegionAB == "ÑUBLE") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round((monto2025 / sum(monto2025)) * 100,2)
  )

ggplot(SH_NUBLE, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(round(porcentaje, 3), nsmall = 1, decimal.mark = ","), "%)") ),
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nregión del Ñuble",
    x = NULL,
    y = "",
    caption = "Figura 46: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la región del Ñuble. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrado, agua potable rural concentrado y \nagua potable rural disperso. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85), color = "#555555")
  ) +
  expand_limits(y = c(0, max(SH_NUBLE$porcentaje) + 5))+
   scale_y_continuous(labels = scales::percent_format(scale = 1, decimal.mark = ","))



```






## Bíobío




```{r, fig.cap = NULL}
SERVICIOS_BBIO <- BASE %>%
  filter(RegionAB == "BIOBÍO") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DA", "DGA","DAP") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto2025 / sum(Monto2025) * 100,2))


ggplot(SERVICIOS_BBIO , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(Porcentaje, nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la región del Biobío",
       x = "",
       y = "Inversión (miles de pesos)",
        caption = "Figura 47: Inversión para los servicios asociados al MOP para la región deL Biobío. Fuente: Elaboración propia a partir de \nlos datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DAP, DGA y DA") +
    scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_BBIO$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
        plot.caption = element_text(size = 9, hjust = -0.2, margin = margin(t = 20, l =-45), color = "#555555")

)



otros_data_BBIO <- BASE %>%
  filter(RegionAB == "BIOBÍO") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DA", "DGA","DAP")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 2), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_BBIO, "html", col.names = c("Servicio", "Inversión 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 33: Servicios agrupados en ‘Otros’, los cuáles incluyen DA, DGA y DAP para la región del Biobío. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.</span>", general_title = "", escape = FALSE)


```




```{r, fig.cap = NULL}

tab_eje_ministerial_cat_BIOBIO <- BASE %>%
  filter(RegionAB == "BIOBÍO" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = round(Monto2025 / total_global * 100,2)
  )


ggplot(tab_eje_ministerial_cat_BIOBIO, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyectos de Arrastre", "Nuevo" = "Proyectos Nuevos"))) +
  labs(title = "Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial \npara la región del Bíobío",
    x = "", 
    y = "Inversión (miles de pesos)", 
    fill = "",
    caption = "Figura 48: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la región del \nBiobío. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."

  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje, 2), big.mark = ".", decimal.mark = ","), "%"
)), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
  theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555")) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + # Divide la leyenda en 2 filas
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )




```

```{r}

tab_poblacion_Biobio <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "BIOBÍO") %>%  
  select(NombreComuna, `Población censada`, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2024" = first(`Población censada`),  
    "Población 2025" = first(`Suma de Poblacion 2025`),  
"Crec/Decrec relativo de Población 2024 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(`Población censada`)) / first(`Población censada`) * 100, 1), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 1
),

    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
)
  )



tab_monto_BIOBIO <- BASE %>%
  filter(RegionAB == "BIOBÍO") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`)) %>% 
  mutate(NombreComuna = case_when(NombreComuna == "ALTO BIO BIO" ~ "ALTO BIOBIO", TRUE ~ NombreComuna) )



tab_resumen_BIOBIO <- left_join(tab_poblacion_Biobio,tab_monto_BIOBIO, by = "NombreComuna")



tab_resumen_BIOBIO %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
    mutate(Monto2025 = case_when(NombreComuna == "SAN ROSENDO" ~ 0,
                               TRUE ~ Monto2025)) |> 
mutate(`Población 2024` = scales::comma(`Población 2024`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), 
      Monto2025 = ifelse(is.na(Monto2025), "Por definir", scales::comma(Monto2025, big.mark = ".", decimal.mark = ",")) ) %>%
  mutate(NombreComuna = case_when(
    NombreComuna == "ALTO BIOBIO" ~ "ALTO BIOBÍO",
    NombreComuna == "CONCEPCION" ~ "CONCEPCIÓN",
    NombreComuna == "HUALPEN" ~ "HUALPÉN",
    NombreComuna == "LOS ALAMOS" ~ "LOS ÁLAMOS",
    NombreComuna == "LOS ANGELES" ~ "LOS ÁNGELES",
    NombreComuna == "MULCHEN" ~ "MULCHÉN",
    NombreComuna == "SANTA BARBARA" ~ "SANTA BÁRBARA",
    NombreComuna == "TIRUA" ~ "TIRÚA",
    NombreComuna == "TOME" ~ "TOMÉ",
    TRUE ~ NombreComuna
    )) %>% 
  kable("html", col.names = c("Comuna", "Población 2024", "Población 2025 (*)", "Crec/Decrec relativo (%) de Población 2024 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "<span style='font-size: 12px;'>Tabla 34: Poblaciones e Inversiones 2025 en la región del Biobío. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN 2022. (*) Población proyectada al 2025 según el INE. (**) Indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores 'Por definir' en la columna Inversión corresponden a comunas que forman parte de proyectos intercomunales pero que no tienen un monto asociado.</span>", 
         general_title = "", 
         escape = FALSE)



```




```{r, fig.cap = NULL}
CC_NA_OTROS_BBIO <- BASE %>%
  filter(RegionAB == "BIOBÍO") %>%
  mutate(CambioClimaticoA = ifelse(is.na(CambioClimaticoA), "No Aplica", "Otros")) %>%
  group_by(CambioClimaticoA) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
     porcentaje = round(Monto2025 / sum(Monto2025) * 100, 2),
    porcentaje = scales::comma(porcentaje, big.mark = ".", decimal.mark = ",", accuracy = 0.01),
    etiqueta = paste0(CambioClimaticoA, "\n", porcentaje, "%"),
    leyenda_texto = paste0(CambioClimaticoA, " - ", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))
  )

ggplot(CC_NA_OTROS_BBIO, aes(x = "", y = Monto2025, fill = CambioClimaticoA)) +
  geom_bar(stat = "identity", width = 1, color = "white") + 
  coord_polar("y", start = 0) + 
  geom_text(
    aes(label = etiqueta), 
    position = position_stack(vjust = 0.5), 
    size = 4, 
    color = "black",
    fontface = "bold"
  ) +
  scale_fill_manual(
    values = alpha(c( "#578E7E","cornsilk3"), .7),
    labels = CC_NA_OTROS_BBIO$leyenda_texto
  ) +
  labs(
    title = "Distribución porcentual de Inversión 2025 por categoría de Cambio Climático \n para la región del Biobío",
    caption = "Figura 49: Inversiones 2025 según tipo de proyecto vinculado al Cambio Climático para la región del Biobío. \nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. \nNota: La categoría 'Otros' incluye a aquellos proyectos pertenecientes a 'Adaptación', 'Mitigación' y \n'Mixto, mitigación y adaptación'. ",
    fill = "Categoría"
  ) +
  theme_minimal() +
  theme(
   legend.text = element_text(size=10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0, margin = margin(b = 20)),
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-50), color = "#555555"),
    panel.grid = element_blank(), 
    axis.title = element_blank(), 
    axis.text = element_blank(),  
    axis.ticks = element_blank()
  )


```





```{r}
CC_BBIO <- BASE %>%
  group_by(CambioClimaticoA) %>%
  filter(RegionAB == "BIOBÍO") %>%
  summarise(MONTO2025 = sum(`Monto 2025`, na.rm = TRUE)) %>% 
  mutate(
    Porcentaje = round((MONTO2025 / sum(MONTO2025)) * 100,2),
    Porcentaje = scales::comma(Porcentaje, big.mark = ".",decimal.mark = ",",accuracy = 0.01)
  ) %>% filter(CambioClimaticoA != "NA")


CC_BBIO %>%
  mutate(MONTO2025 = scales::comma(MONTO2025, big.mark = ".", decimal.mark = ",")) %>% 
  kable(
    "html",
    col.names = c("Cambio Climático", "Inversión 2025", "Porcentaje")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    font_size = 14
  )%>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 35: Desglose de la categoría 'Otros' de los proyectos relacionados a Cambio Climático para la región del Biobío. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria</span>", escape = FALSE, general_title = "")

```




```{r, fig.cap = NULL}


SH_BBIO <- BASE %>%
  filter(RegionAB == "BIOBÍO") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round((monto2025 / sum(monto2025)) * 100,2)
  )

ggplot(SH_BBIO, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(porcentaje, nsmall = 1, decimal.mark = ","), "%)")
    ),
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nregión del BioBío",
    x = NULL,
    y = "",
    caption = "Figura 50: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la región del Biobío. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrado, agua potable rural concentrado y \nagua potable rural disperso. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85), color = "#555555")
  ) +
  expand_limits(y = c(0, max(SH_BBIO$porcentaje) + 5))+
  scale_y_continuous(labels = scales::percent_format(scale = 1, decimal.mark = ","))



```



## La Araucanía


```{r, fig.cap = NULL}

SERVICIOS_ARAUC <- BASE %>%
  filter(RegionAB == "LA ARAUCANÍA") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DOP", "DAP") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto2025 / sum(Monto2025) * 100,1))


ggplot(SERVICIOS_ARAUC , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(Porcentaje, nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la región de La Araucanía",
       x = "",
       y = "Inversión (miles de pesos)",
       caption = "Figura 51: Inversión 2025 para los servicios asociados al MOP para la región de La Araucanía. Fuente: Elaboración propia a \npartir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DOP y \nDAP."
) +
    scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_ARAUC$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
         plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555"
))



otros_data_ARAUC <- BASE %>%
  filter(RegionAB == "LA ARAUCANÍA") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DOP", "DAP") ) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_ARAUC, "html", col.names = c("Servicio", "Inversión 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 36: Servicios agrupados en ‘Otros’, los cuáles incluyen DAP y DOP para la región de La Araucanía. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.</span>", general_title = "", escape = FALSE)



```



```{r, fig.cap = NULL}

tab_eje_ministerial_cat_ARAUC <- BASE %>%
  filter(RegionAB == "LA ARAUCANÍA" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = round(Monto2025 / total_global * 100,1) 
  )


ggplot(tab_eje_ministerial_cat_ARAUC, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyectos de Arrastre", "Nuevo" = "Proyectos Nuevos"))) +
  labs(title = "Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial\n para la región de La Araucanía",
    x = "", 
    y = "Inversión (miles de pesos)", 
    fill = "",
    caption = "Figura 52: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la región \nde La Araucanía. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."


  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(porcentaje, big.mark = ".", decimal.mark = ","), "%"
)
), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
  theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-30), color = "#555555")) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + 
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )




```

```{r}




tab_poblacion_Araucania <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "LA ARAUCANÍA") %>%
  select(NombreComuna, `Población censada`, `Suma de Poblacion 2025`,`Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2024" = first(`Población censada`),
    "Población 2025" = first(`Suma de Poblacion 2025`),
    "Crec/Decrec relativo de Población 2024 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(`Población censada`)) / first(`Población censada`) * 100, 1), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 1
),

    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))



tab_monto_ARAUC <- BASE %>%
  filter(RegionAB == "LA ARAUCANÍA") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))


tab_resumen_ARAUC <- left_join(tab_poblacion_Araucania,tab_monto_ARAUC, by = "NombreComuna")



tab_resumen_ARAUC %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
mutate(`Población 2024` = scales::comma(`Población 2024`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), 
       Monto2025 = ifelse(is.na(Monto2025), "Por definir", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))) %>%
  mutate(NombreComuna = case_when(
    NombreComuna == "CURACAUTIN" ~ "CURACAUTÍN",
    NombreComuna == "PITRUFQUEN" ~ "PITRUFQUÉN",
    NombreComuna == "PUCON" ~ "PUCÓN",
    NombreComuna == "PUREN" ~ "PURÉN",
    NombreComuna == "TOLTEN" ~ "TOLTÉN",
    NombreComuna == "TRAIGUEN" ~ "TRAIGUÉN",
    NombreComuna == "VILCUN" ~ "VILCÚN",
    TRUE ~ NombreComuna
                                  )) %>% 
  kable("html", col.names = c("Comuna", "Población 2024", "Población 2025 (*)", "Crec/Decrec relativo (%) de Población 2024 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "<span style='font-size: 12px;'>Tabla 37: Poblaciones e Inversiones 2025 en la región de La Araucanía. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN 2022. (*) Población proyectada al 2025 según el INE. (**) Indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores 'Por definir' en la columna Inversión corresponden a comunas que forman parte de proyectos intercomunales pero que no tienen un monto asociado.</span>", 
         general_title = "", 
         escape = FALSE)



```




```{r, fig.cap = NULL}
CC_NA_OTROS_ARAUC <- BASE %>%
  filter(RegionAB == "LA ARAUCANÍA") %>%
  mutate(CambioClimaticoA = ifelse(is.na(CambioClimaticoA), "No Aplica", "Otros")) %>%
  group_by(CambioClimaticoA) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round(Monto2025 / sum(Monto2025) * 100, 2),
    porcentaje = scales::comma(porcentaje, big.mark = ".", decimal.mark = ",", accuracy = 0.01),
    etiqueta = paste0(CambioClimaticoA, "\n", porcentaje, "%"),
    leyenda_texto = paste0(CambioClimaticoA, " - ", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))
  )

ggplot(CC_NA_OTROS_ARAUC, aes(x = "", y = Monto2025, fill = CambioClimaticoA)) +
  geom_bar(stat = "identity", width = 1, color = "white") + 
  coord_polar("y", start = 0) + 
  geom_text(
    aes(label = etiqueta), 
    position = position_stack(vjust = 0.5), 
    size = 4, 
    color = "black",
    fontface = "bold"
  ) +
  scale_fill_manual(
    values = alpha(c( "#578E7E","cornsilk3"), .7),
    labels = CC_NA_OTROS_ARAUC$leyenda_texto
  ) +
  labs(
    title = "Distribución porcentual de Inversión 2025 por categoría de Cambio Climático \n para la región de La Araucanía",
    caption = "Figura 53: Inversiones 2025 según tipo de proyecto vinculado al Cambio Climático para la región de La Araucanía. \nFuente: Elaboración propia a partir  de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría '\nOtros' incluye a aquellos proyectos pertenecientes a 'Adaptación', 'Mitigación' y 'Mixto, mitigación y adaptación'. ",
    fill = "Categoría"
  ) +
  theme_minimal() +
  theme(
    legend.text = element_text(size=10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0, margin = margin(b = 20)),
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555"),
    panel.grid = element_blank(), 
    axis.title = element_blank(), 
    axis.text = element_blank(),  
    axis.ticks = element_blank()
  )


```


```{r}
CC_ARAUC <- BASE %>%
  group_by(CambioClimaticoA) %>%
  filter(RegionAB == "LA ARAUCANÍA") %>%
  summarise(MONTO2025 = sum(`Monto 2025`, na.rm = TRUE)) %>% 
  mutate(
    Porcentaje = round((MONTO2025 / sum(MONTO2025)) * 100,2),
    Porcentaje = scales::comma(Porcentaje, big.mark = ".",decimal.mark = ",",accuracy = 0.01)
  ) %>% filter(CambioClimaticoA != "NA")


CC_ARAUC %>%
  mutate(MONTO2025 = scales::comma(MONTO2025, big.mark = ".", decimal.mark = ",")) %>% 
  kable(
    "html",
    col.names = c("Cambio Climático", "Inversión 2025", "Porcentaje")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    font_size = 14
  )%>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 38: Desglose de la categoría 'Otros' de los proyectos relacionados a Cambio Climático para la región de La Araucanía. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria</span>", escape = FALSE, general_title = "")

```




```{r, fig.cap = NULL}


SH_ARAUC <- BASE %>%
  filter(RegionAB == "LA ARAUCANÍA") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round((monto2025 / sum(monto2025)) * 100,2)
  )

ggplot(SH_ARAUC, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(porcentaje, nsmall = 1, decimal.mark = ","), "%)")
    ),
    fontface = "bold",
    vjust = 1.6,
    size = 3
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nregión de La Araucanía",
    x = NULL,
    y = "",
    caption = "Figura 54: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la región de La Araucanía. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrado, agua potable rural concentrado y \nagua potable rural disperso. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85), color = "#555555")
  ) +
  expand_limits(y = c(0, max(SH_ARAUC$porcentaje) + 5))+
  scale_y_continuous(labels = scales::percent_format(scale = 1, decimal.mark = ","))



```



## Los Ríos



```{r, fig.cap = NULL}
SERVICIOS_RIOS <- BASE %>%
  filter(RegionAB == "LOS RÍOS") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DOH", "DGA","DGC","DA") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto2025 / sum(Monto2025) * 100,3))


ggplot(SERVICIOS_RIOS , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(Porcentaje, nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de inversión 2025 por servicios MOP para la región de Los Ríos",
       caption = "Figura 55: Inversión 2025 para los servicios asociados al MOP para la región de Los Ríos. Fuente: Elaboración propia a \npartir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DOH, \nDGA DGC y DA.",
       x = "",
       y = "Inversión (miles de pesos)") +
    scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_RIOS$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
         plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555")) 




otros_data_RIOS <- BASE %>%
  filter(RegionAB == "LOS RÍOS") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DOH", "DGA","DGC","DA")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_RIOS, "html", col.names = c("Servicio", "Inversión 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 39: Servicios agrupados en ‘Otros’, los cuáles incluyen DOH, DGA DGC y DA para la región de Los Ríos. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.</span>",escape = FALSE, general_title = "")




```




```{r, fig.cap = NULL}

tab_eje_ministerial_cat_RIOS <- BASE %>%
  filter(RegionAB == "LOS RÍOS" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = round(Monto2025 / total_global * 100,3) 
  )


ggplot(tab_eje_ministerial_cat_RIOS, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyectos de Arrastre", "Nuevo" = "Proyectos Nuevos"))) +
  labs(
    title = "Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial \npara la región de Los Ríos", 
    x = "", 
    y = "Inversión (miles de pesos)", 
    fill = "",
    caption = "Figura 56: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la región \nde Los Ríos. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."

  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje,2), big.mark = ".", decimal.mark = ","), "%"
)
), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-30), color = "#555555")) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + # Divide la leyenda en 2 filas
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )




```

```{r}


tab_poblacion_LosRios <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "LOS RÍOS") %>%
  select(NombreComuna, `Población censada`, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2024" = first(`Población censada`),
    "Población 2025" = first(`Suma de Poblacion 2025`),
    "Crec/Decrec relativo de Población 2024 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(`Población censada`)) / first(`Población censada`) * 100, 1), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 1
),

    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
)
  )



tab_monto_RIOS <- BASE %>%
  filter(RegionAB == "LOS RÍOS") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))


tab_resumen_RIOS <- left_join(tab_poblacion_LosRios,tab_monto_RIOS, by = "NombreComuna")





tab_resumen_RIOS %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
mutate(`Población 2024` = scales::comma(`Población 2024`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), 
       Monto2025 = ifelse(is.na(Monto2025), "Por definir", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))) %>%
  mutate(NombreComuna = case_when(
                          NombreComuna == "LA UNION" ~ "LA UNIÓN",
                          NombreComuna == "MAFIL" ~ "MÁFIL",
                          NombreComuna == "RIO BUENO" ~ "RÍO BUENO",
                          TRUE ~ NombreComuna
                                  )) %>% 
  kable("html", col.names = c("Comuna", "Población 2024", "Población 2025 (*)", "Crec/Decrec relativo (%) de Población 2024 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "<span style='font-size: 12px;'>Tabla 40: Poblaciones e Inversiones 2025 en la región de Los Ríos. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN 2022. (*) Población proyectada al 2025 según el INE. (**) Indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores 'Por definir' en la columna Inversión corresponden a comunas que forman parte de proyectos intercomunales pero que no tienen un monto asociado.</span>", 
         general_title = "", 
         escape = FALSE)



```



```{r, fig.cap = NULL}
CC_NA_OTROS_RIOS <- BASE %>%
  filter(RegionAB == "LOS RÍOS") %>%
  mutate(CambioClimaticoA = ifelse(is.na(CambioClimaticoA), "No Aplica", "Otros")) %>%
  group_by(CambioClimaticoA) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round(Monto2025 / sum(Monto2025) * 100, 2),
    porcentaje = scales::comma(porcentaje, big.mark = ".", decimal.mark = ",", accuracy = 0.01),
    etiqueta = paste0(CambioClimaticoA, "\n", porcentaje, "%"),
    leyenda_texto = paste0(CambioClimaticoA, " - ", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))
  )

ggplot(CC_NA_OTROS_RIOS, aes(x = "", y = Monto2025, fill = CambioClimaticoA)) +
  geom_bar(stat = "identity", width = 1, color = "white") + 
  coord_polar("y", start = 0) + 
  geom_text(
    aes(label = etiqueta), 
    position = position_stack(vjust = 0.5), 
    size = 4, 
    color = "black",
    fontface = "bold"
  ) +
  scale_fill_manual(
    values = alpha(c( "#578E7E","cornsilk3"), .7),
    labels = CC_NA_OTROS_RIOS$leyenda_texto
  ) +
  labs(
    title = "Distribución porcentual de Inversión 2025 por categoría de Cambio Climático \n para la región de Los Ríos",
    caption = "Figura 57: Inversiones 2025 según tipo de proyecto vinculado al Cambio Climático para la región de Los Ríos. \nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' \nincluye a aquellos proyectos pertenecientes a 'Adaptación', 'Mitigación' y 'Mixto, mitigación y adaptación'. ",
    fill = "Categoría"
  ) +
  theme_minimal() +
  theme(
    legend.text = element_text(size=10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0, margin = margin(b = 20)),
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555"),
    panel.grid = element_blank(), 
    axis.title = element_blank(), 
    axis.text = element_blank(),  
    axis.ticks = element_blank()
  )


```






```{r}
CC_RIOS <- BASE %>%
  filter(RegionAB == "LOS RÍOS") %>%
  group_by(CambioClimaticoA) %>%
  summarise(MONTO2025 = sum(`Monto 2025`, na.rm = TRUE)) %>% 
  mutate(
    Porcentaje = round((MONTO2025 / sum(MONTO2025)) * 100,2),
    Porcentaje = scales::comma(Porcentaje, big.mark = ".",decimal.mark = ",",accuracy = 0.01)
  ) %>% filter(CambioClimaticoA != "NA")


CC_RIOS %>%
  mutate(MONTO2025 = scales::comma(MONTO2025, big.mark = ".", decimal.mark = ",")) %>% 
  kable(
    "html",
    col.names = c("Cambio Climático", "Inversión 2025", "Porcentaje")
  ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    font_size = 14
  )%>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 41: Desglose de la categoría 'Otros' de los proyectos relacionados a Cambio Climático para la región de Los Ríos. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria</span>", escape = FALSE, general_title = "")

```



```{r, fig.cap = NULL}


SH_RIOS <- BASE %>%
  filter(RegionAB == "LOS RÍOS") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round((monto2025 / sum(monto2025)) * 100,2)
  )

ggplot(SH_RIOS, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(porcentaje, nsmall = 1, decimal.mark = ","), "%)")
    ),
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nregión de Los Ríos",
    x = NULL,
    y = "",
    caption = "Figura 58: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la región de Los Ríos. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrado, agua potable rural concentrado y \nagua potable rural disperso. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."

  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555")

  ) +
  expand_limits(y = c(0, max(SH_RIOS$porcentaje) + 5))+
  scale_y_continuous(labels = scales::percent_format(scale = 1, decimal.mark = ","))


```






## Los Lagos

```{r, fig.cap = NULL}
SERVICIOS_LAGOS <- BASE %>%
  filter(RegionAB == "LOS LAGOS") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DA", "DGA","DOH") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto2025 / sum(Monto2025) * 100,3))



ggplot(SERVICIOS_LAGOS , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(Porcentaje, nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la Región de Los Lagos",
       x = "",
       y = "Inversión (miles de pesos)",
       caption = "Figura 59: Inversión 2025 para los servicios asociados al MOP para la región de Los Lagos. Fuente: Elaboración propia a \npartir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios DA, DGA \ny DOH") +
    scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_LAGOS$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
         plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555")
)



otros_data_LAGOS <- BASE %>%
  filter(RegionAB == "LOS LAGOS") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in%  c("DA", "DGA","DOH")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje,3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_LAGOS, "html", col.names = c("Servicio", "Inversión 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 42: Servicios agrupados en ‘Otros’, los cuáles incluyen DA, DGA y DOH para la región de Los Lagos. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.</span>", general_title = "", escape=FALSE)


```




```{r, fig.cap = NULL}

tab_eje_ministerial_cat_LAGOS <- BASE %>%
  filter(RegionAB == "LOS LAGOS" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = round(Monto2025 / total_global * 100,1) 
  )


ggplot(tab_eje_ministerial_cat_LAGOS, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyectos de Arrastre", "Nuevo" = "Proyectos Nuevos"))) +
  labs(title = "Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial \npara la región de Los Lagos", 
    x = "", 
    y = "Inversión (miles de pesos)", 
    fill = "",
    caption = "Figura 60: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la región de \nLos Lagos. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."


  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(porcentaje, big.mark = ".", decimal.mark = ","), "%"
)
), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555")) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + # Divide la leyenda en 2 filas
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )


```

```{r}

tab_poblacion_LosLagos <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "LOS LAGOS") %>%
  select(NombreComuna, `Población censada`, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2024" = first(`Población censada`),
    "Población 2025" = first(`Suma de Poblacion 2025`),
"Crec/Decrec relativo de Población 2024 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(`Población censada`)) / first(`Población censada`) * 100, 2), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 2
),

    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))




tab_monto_LAGOS <- BASE %>%
  filter(RegionAB == "LOS LAGOS") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))


tab_resumen_LAGOS <- left_join(tab_poblacion_LosLagos,tab_monto_LAGOS, by = "NombreComuna")





tab_resumen_LAGOS  %>% 
mutate(`Población 2024` = scales::comma(`Población 2024`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), 
       Monto2025 = ifelse(is.na(Monto2025), "Por definir", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))) %>%
  
    mutate(NombreComuna =  case_when(
    NombreComuna == "ANCUD" ~ "ANCÚD",
    NombreComuna == "CHAITEN" ~ "CHAITÉN",
    NombreComuna == "CURACO DE VELEZ" ~ "CURACO DE VÉLEZ",
    NombreComuna == "FUTALEUFU" ~ "FUTALEUFÚ",
    NombreComuna == "HUALAIHUE" ~ "HUALAIHUÉ",
    NombreComuna == "MAULLIN" ~ "MAULLÍN",
    NombreComuna == "PUQUELDON" ~ "PUQUELDÓN",
    NombreComuna == "QUEILEN" ~ "QUEILÉN",
    NombreComuna == "QUELLON" ~ "QUELLÓN",
    NombreComuna == "RIO NEGRO" ~ "RÍO NEGRO",
    TRUE ~ NombreComuna)) %>%
  
  kable("html", col.names = c("Comuna", "Población 2024", "Población 2025 (*)", "Crec/Decrec relativo (%) de Población 2024 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión")) %>%
 
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>%footnote(general = "<span style='font-size: 12px;'>Tabla 43: Poblaciones e Inversiones 2025 en la región de Los Lagos. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN 2022. (*) Población proyectada al 2025 según el INE. (**) Indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores 'Por definir' en la columna Inversión corresponden a comunas que forman parte de proyectos intercomunales pero que no tienen un monto asociado.</span>", 
         general_title = "", 
         escape = FALSE)




```




```{r, fig.cap = NULL}
CC_NA_OTROS_LAGOS <- BASE %>%
  filter(RegionAB == "LOS LAGOS") %>%
  mutate(CambioClimaticoA = ifelse(is.na(CambioClimaticoA), "No Aplica", "Otros")) %>%
  group_by(CambioClimaticoA) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round(Monto2025 / sum(Monto2025) * 100, 2),
    porcentaje = scales::comma(porcentaje, big.mark = ".", decimal.mark = ",", accuracy = 0.01),
    etiqueta = paste0(CambioClimaticoA, "\n", porcentaje, "%"),
    leyenda_texto = paste0(CambioClimaticoA, " - ", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))
  )

ggplot(CC_NA_OTROS_LAGOS, aes(x = "", y = Monto2025, fill = CambioClimaticoA)) +
  geom_bar(stat = "identity", width = 1, color = "white") + 
  coord_polar("y", start = 0) + 
  geom_text(
    aes(label = etiqueta), 
    position = position_stack(vjust = 0.5), 
    size = 4, 
    color = "black",
    fontface = "bold"
  ) +
  scale_fill_manual(
    values = alpha(c( "#578E7E","cornsilk3"), .7),
    labels = CC_NA_OTROS_LAGOS$leyenda_texto
  ) +
  labs(
    title = "Distribución porcentual de Inversión 2025 por categoría de Cambio Climático \npara la región de Los Lagos",
    caption = "Figura 61: Inversión 2025 según tipo de proyecto vinculado al Cambio Climático para la región de Los Lagos. \nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría \n'Otros' incluye a aquellos proyectos pertenecientes a 'Adaptación', 'Mitigación' y 'Mixto, mitigación y adaptación'. "
,
    fill = "Categoría"
  ) +
  theme_minimal() +
  theme(
  legend.text = element_text(size=10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0, margin = margin(b = 20)),
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-48), color = "#555555"),
    panel.grid = element_blank(), 
    axis.title = element_blank(), 
    axis.text = element_blank(),  
    axis.ticks = element_blank()

  )


```






```{r}

CC_LAGOS <- BASE %>%
  group_by(CambioClimaticoA) %>%
  filter(RegionAB == "LOS LAGOS") %>%
  summarise(MONTO2025 = sum(`Monto 2025`, na.rm = TRUE)) %>% 
  mutate(
    Porcentaje = round((MONTO2025 / sum(MONTO2025)) * 100,2),
    Porcentaje = scales::comma(Porcentaje, big.mark = ".",decimal.mark = ",",accuracy = 0.01)
  ) %>% filter(CambioClimaticoA != "NA")


CC_LAGOS %>%
  mutate(MONTO2025 = scales::comma(MONTO2025, big.mark = ".", decimal.mark = ",")) %>% 
  kable(
    "html",
    col.names = c("Cambio Climático", "Inversión 2025", "Porcentaje") ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    font_size = 14
  )%>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 44: Desglose de la categoría 'Otros' de los proyectos relacionados a Cambio Climático para la región de Los Lagos. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria</span>", escape = FALSE, general_title = "")

```






```{r, fig.cap = NULL}


SH_LAGOS <- BASE %>%
  filter(RegionAB == "LOS LAGOS") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round((monto2025 / sum(monto2025)) * 100,2)
  )

ggplot(SH_LAGOS, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(porcentaje, nsmall = 1, decimal.mark = ","), "%)")
    ),
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nregión de Los Lagos",
    x = NULL,
    y = "",
    caption = "Figura 62: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la región de Los Lagos. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrado, agua potable rural concentrado y \nagua potable rural disperso. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85), color = "#555555")
  ) +
  expand_limits(y = c(0, max(SH_LAGOS$porcentaje) + 5)) +
  scale_y_continuous(labels = scales::percent_format(scale = 1, decimal.mark = ","))



```






## Aysén del General Carlos Ibáñez del Campo




```{r, fig.cap = NULL}
SERVICIOS_AYSEN <- BASE %>%
  filter(RegionAB == "AYSÉN") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DA", "DGA","DGC","DP","DOP") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto2025 / sum(Monto2025) * 100,3))


ggplot(SERVICIOS_AYSEN , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(Porcentaje, nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 2.7, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la región de Aysén \n del General Carlos Ibáñez del Campo",
       x = "",
       y = "Inversión (miles de pesos)",
       caption = "Figura 63: Inversión 2025 para los servicios asociados al MOP para la región de Aysén del General Carlos Ibáñez del \nCampo. Fuente: Elaboración propia a partir de los datos del  Departamento de Gestión Presupuestaria. Nota: La categoría \n'Otros' comprende los servicios DA, DGA, DGC, DP y DOP."
) +
    scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_AYSEN$Monto2025) * 1.1), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
         plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555")
)



otros_data_AYSEN <- BASE %>%
  filter(RegionAB == "AYSÉN") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DA", "DGA","DGC","DP","DOP")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_AYSEN, "html", col.names = c("Servicio", "Inversión 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 45: Servicios agrupados en ‘Otros’, los cuáles incluyen DA, DGA, DGC, DP y DOP para la región de Aysén del General Carlos Ibáñez del Campo. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.</span>", general_title = "", escape = FALSE)


```






```{r, fig.cap = NULL}

tab_eje_ministerial_cat_AYSEN <- BASE %>%
  filter(RegionAB == "AYSÉN" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = round(Monto2025 / total_global * 100,2)
  )


ggplot(tab_eje_ministerial_cat_AYSEN, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyectos de Arrastre", "Nuevo" = "Proyectos Nuevos"))) +
  labs(
title = "Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial \npara la región de Aysén del General Carlos Ibáñez del Campo.",     
    x = "", 
    y = "Inversión (miles de pesos)", 
    fill = "",
caption = "Figura 64: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la región de \nAysén del General Carlos Ibáñez del Campo. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión \nPresupuestaria."
  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(porcentaje, big.mark = ".", decimal.mark = ","), "%"
)
), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555")) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + # Divide la leyenda en 2 filas
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )




```

```{r}


tab_poblacion_Aysen <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "AYSÉN") %>%
  select(NombreComuna, `Población censada`, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2024" = first(`Población censada`),
    "Población 2025" = first(`Suma de Poblacion 2025`),
    "Crec/Decrec relativo de Población 2024 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(`Población censada`)) / first(`Población censada`) * 100, 2), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 2
),

    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
)
  )



tab_monto_Aysen <- BASE %>%
  filter(RegionAB == "AYSÉN") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`)) %>% 
    mutate(NombreComuna = case_when(NombreComuna == "COIHAIQUE" ~ "COYHAIQUE", TRUE ~ NombreComuna) )

tab_resumen_Aysen <- left_join(tab_poblacion_Aysen,tab_monto_Aysen, by = "NombreComuna")



tab_resumen_Aysen %>% 
mutate(`Población 2024` = scales::comma(`Población 2024`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), 
       Monto2025 = ifelse(is.na(Monto2025), "Por definir", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))) %>%
  
  mutate(NombreComuna = case_when(NombreComuna == "AYSEN" ~ "AYSÉN",
                    NombreComuna == "RIO IBAÑEZ" ~ "RÍO IBAÑEZ",
                    TRUE ~ NombreComuna)) %>% 
  
  kable("html", col.names = c("Comuna", "Población 2024", "Población 2025 (*)", "Crec/Decrec relativo (%) de Población 2024 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "<span style='font-size: 12px;'>Tabla 46: Poblaciones e Inversiones 2025 en la región de Aysén del General Carlos Ibáñez del Campo. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN 2022. (*) Población proyectada al 2025 según el INE. (**) Indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores 'Por definir' en la columna Inversión corresponden a comunas que forman parte de proyectos intercomunales pero que no tienen un monto asociado.</span>", 
         general_title = "", 
         escape = FALSE)




```



```{r, fig.cap = NULL}
CC_NA_OTROS_AYSEN <- BASE %>%
  filter(RegionAB == "AYSÉN") %>%
  mutate(CambioClimaticoA = ifelse(is.na(CambioClimaticoA), "NA", "Otros")) %>%
  group_by(CambioClimaticoA) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round(Monto2025 / sum(Monto2025) * 100, 2),
    porcentaje = scales::comma(porcentaje, big.mark = ".", decimal.mark = ",", accuracy = 0.01),
    etiqueta = paste0(CambioClimaticoA, "\n", porcentaje, "%"),
    leyenda_texto = paste0(CambioClimaticoA, " - ", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))
  )

ggplot(CC_NA_OTROS_AYSEN, aes(x = "", y = Monto2025, fill = CambioClimaticoA)) +
  geom_bar(stat = "identity", width = 1, color = "white") + 
  coord_polar("y", start = 0) + 
  geom_text(
    aes(label = etiqueta), 
    position = position_stack(vjust = 0.5), 
    size = 4, 
    color = "black",
    fontface = "bold"
  ) +
  scale_fill_manual(
    values = alpha(c( "#578E7E","cornsilk3"), .7),
    labels = CC_NA_OTROS_AYSEN$leyenda_texto
  ) +
  labs(
    title = "Distribución porcentual de inversiones 2025 por categoría de Cambio Climático\n para la región de Aysén del General Carlos Ibáñez del Campo.",
      caption = "Figura 65: Inversión 2025 según tipo de proyecto vinculado al Cambio Climático para la región de Aysén del \nGeneral Carlos Ibáñez del Campo.\nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría \n'Otros' incluye a aquellos proyectos pertenecientes a 'Adaptación' 'Mitigación' y 'Mixto, mitigación y adaptación'. ",
    fill = "Categoría"
  ) +
  theme_minimal() +
  theme(
      legend.text = element_text(size=10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0, margin = margin(b = 20)),
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-50), color = "#555555"),
    panel.grid = element_blank(), 
    axis.title = element_blank(), 
    axis.text = element_blank(),  
    axis.ticks = element_blank()
  )


```




```{r}
CC_AYSEN <- BASE %>%
  group_by(CambioClimaticoA) %>%
  filter(RegionAB == "AYSÉN") %>%
  summarise(MONTO2025 = sum(`Monto 2025`, na.rm = TRUE)) %>% 
  mutate(
    Porcentaje = round((MONTO2025 / sum(MONTO2025)) * 100,2),
    Porcentaje = scales::comma(Porcentaje, big.mark = ".",decimal.mark = ",",accuracy = 0.01)
  ) %>% filter(CambioClimaticoA != "NA")


CC_AYSEN %>%
  mutate(MONTO2025 = scales::comma(MONTO2025, big.mark = ".", decimal.mark = ",")) %>% 
  kable(
    "html",
    col.names = c("Cambio Climático", "Inversión 2025", "Porcentaje")) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    font_size = 14
  )%>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 47: Desglose de la categoría 'Otros' de los proyectos relacionados a Cambio Climático para la región de Aysén del General Carlos Ibáñez del Campo. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria</span>", escape = FALSE, general_title = "")

```





```{r, fig.cap = NULL}


SH_AYSEN <- BASE %>%
  filter(RegionAB == "AYSÉN") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round((monto2025 / sum(monto2025)) * 100,2)
  )

ggplot(SH_AYSEN, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(porcentaje, nsmall = 1, decimal.mark = ","), "%)") ),
    fontface = "bold",
    vjust = 1.6,
    size = 3
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nregión de Aysén del General Carlos Ibáñez del Campo",
    x = NULL,
    y = "",
    caption = "Figura 66: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la región de Aysén del General Carlos Ibáñez del Campo. Fuente: Elaboración propia a partir de datos del \nDepartamento de Gestión Presupuestaria. Nota: La categorización del programa dipres fue realizada en cuatro clases. \nLa primera es 'Consumo Humano' que está compuesta por los programas pertenecientes a: agua potable rural \nsemi-concentrado, agua potable rural concentrado y agua potable rural disperso. La segunda es 'Riego' que agrupa: \ngrandes obras de riego, conservación de obras de riego, explotación de obras de riego obras de riego. La categoría\n 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, estudio y otros. \nFinalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de recursos hídricos y \nampliación de redes de medición."
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85), color = "#555555")
  ) +
  expand_limits(y = c(0, max(SH_AYSEN$porcentaje) + 5)) +
  scale_y_continuous(labels = scales::percent_format(scale = 1, decimal.mark = ","))



```









## Magallanes y de la Antártica Chilena





```{r, fig.cap = NULL}
SERVICIOS_MAG <- BASE %>%
  filter(RegionAB == "MAGALLANES") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DA", "DGA","DGC","DOH") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto2025 / sum(Monto2025) * 100,2))


ggplot(SERVICIOS_MAG , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(Porcentaje, nsmall = 1, decimal.mark = ","), "%)")), vjust = -0.5, size = 3, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para la región de Magallanes \n y de la Antártica Chilena",
       x = "",
       y = "Inversión (miles de pesos)",
       caption = "Figura 67: Inversión 2025 para los servicios asociados al MOP para la región de Magallanes y de la Antártica Chilena. \nFuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' \ncomprende los servicios \nDA, DGA, DGC y DOH."
) +
    scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_MAG$Monto2025) * 1.3), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
         plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555")

)



otros_data_MAG <- BASE %>%
  filter(RegionAB == "MAGALLANES") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DA", "DGA","DGC","DOH")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_MAG, "html", col.names = c("Servicio", "Inversión 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 48: Servicios agrupados en ‘Otros’, los cuáles incluyen DA, DGA, DGC y DOH para la región de Magallanes y de la Antártica Chilena. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.</span>", general_title = "", escape=FALSE)


```



```{r, fig.cap = NULL}

tab_eje_ministerial_cat_MAG <- BASE %>%
  filter(RegionAB == "MAGALLANES" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = round(Monto2025 / total_global * 100,1)
  )


ggplot(tab_eje_ministerial_cat_MAG, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyectos de Arrastre", "Nuevo" = "Proyectos Nuevos"))) +
  labs(title = "Asignación de la Inversión 2025 según clasificación del proyecto (Arrastre y Nuevo) y Eje Ministerial \npara la región de Magallanes y de la Antártica Chilena",    
    x = "", 
    y = "Inversión (miles de pesos)", 
    fill = "",
    caption = "Figura 68: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para la región de \nMagallanes y de la Antártica Chilena. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión\n Presupuestaria."

  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(round(porcentaje, 2), big.mark = ".", decimal.mark = ","), "%"
)), 
    vjust = -0.5, 
    size = 3, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-40), color = "#555555")) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + # Divide la leyenda en 2 filas
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )


```

```{r}



tab_poblacion_Magallanes <- PROYECCIONES_POBmulti %>%
  filter(RegionAB == "MAGALLANES") %>%
  select(NombreComuna, `Población censada`, `Suma de Poblacion 2025`, `Número de personas en situación de pobreza multidimensional (**)`) %>%
  group_by(NombreComuna) %>%
  summarise(
    "Población 2024" = first(`Población censada`),
    "Población 2025" = first(`Suma de Poblacion 2025`),
    "Crec/Decrec relativo de Población 2024 al 2025" = format(
  round((first(`Suma de Poblacion 2025`) - first(`Población censada`)) / first(`Población censada`) * 100, 2), 
  big.mark = ".", 
  decimal.mark = ",", 
  nsmall = 2
),

    "Pobreza Multidimensional" = scales::comma(
  round(first(`Número de personas en situación de pobreza multidimensional (**)`)), 
  big.mark = "."
))



tab_monto_MAG <- BASE %>%
  filter(RegionAB == "MAGALLANES") %>% 
  select(NombreComuna, `Monto 2025`) %>%
  group_by(NombreComuna) %>%
  summarise("Monto2025" = sum(`Monto 2025`))


tab_resumen_MAG <- left_join(tab_poblacion_Magallanes,tab_monto_MAG, by = "NombreComuna")




tab_resumen_MAG %>% 
  mutate(Monto2025 = if_else(NombreComuna == "PICA", NA_real_, Monto2025)) %>% 
mutate(`Población 2024` = scales::comma(`Población 2024`, big.mark = ".", decimal.mark = ","), `Población 2025` = scales::comma(`Población 2025`, big.mark = ".", decimal.mark = ","), 
       Monto2025 = ifelse(is.na(Monto2025), "Por definir", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))) %>%
  
  mutate(NombreComuna = case_when(NombreComuna == "ANTARTICA" ~ "ANTÁRTICA",
                                  NombreComuna == "RIO VERDE" ~ "RÍO VERDE",
                                  TRUE ~ NombreComuna)) %>% 
  
  kable("html", col.names = c("Comuna", "Población 2024", "Población 2025 (*)", "Crec/Decrec relativo (%) de Población 2024 al 2025", "N° de personas en situación de pobreza multidimensional (**)", "Inversión")) %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover", "condensed", "responsive")) %>% footnote(general = "<span style='font-size: 12px;'>Tabla 49: Poblaciones e Inversiones 2025 en la región de Magallanes y de la Antártica Chilena. Fuente: Elaboración propia basada en datos del INE, del Departamento de Gestión Presupuestaria y CASEN 2022. (*) Población proyectada al 2025 según el INE. (**) Indica la cantidad de personas en situación de pobreza multidimensional para el año 2022. Nota: Los valores 'Por definir' en la columna Inversión corresponden a comunas que forman parte de proyectos intercomunales pero que no tienen un monto asociado.</span>", 
         general_title = "", 
         escape = FALSE)



```






```{r, fig.cap = NULL}
CC_NA_OTROS_MAG <- BASE %>%
  filter(RegionAB == "MAGALLANES") %>%
  mutate(CambioClimaticoA = ifelse(is.na(CambioClimaticoA), "No Aplica", "Otros")) %>%
  group_by(CambioClimaticoA) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round(Monto2025 / sum(Monto2025) * 100, 2),
    porcentaje = scales::comma(porcentaje, big.mark = ".", decimal.mark = ",", accuracy = 0.01),
    etiqueta = paste0(CambioClimaticoA, "\n", porcentaje, "%"),
    leyenda_texto = paste0(CambioClimaticoA, " - ", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))
  )

ggplot(CC_NA_OTROS_MAG, aes(x = "", y = Monto2025, fill = CambioClimaticoA)) +
  geom_bar(stat = "identity", width = 1, color = "white") + 
  coord_polar("y", start = 0) + 
  geom_text(
    aes(label = etiqueta), 
    position = position_stack(vjust = 0.5), 
    size = 4, 
    color = "black",
    fontface = "bold"
  ) +
  scale_fill_manual(
    values = alpha(c( "#578E7E","cornsilk3"), .7),
    labels = CC_NA_OTROS_MAG$leyenda_texto
  ) +
  labs(
    title = "Distribución porcentual de inversiones 2025 por categoría de Cambio Climático \n para la región de Magallanes y de la Antártica Chilena",
    caption = "Figura 69: Inversiones 2025 según tipo de proyecto vinculado al Cambio Climático para la región de Magallanes y de la \nAntártica Chilena. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria. \nNota: La categoría 'Otros' incluye a aquellos proyectos pertenecientes a 'Adaptación', 'Mitigación' \ny 'Mixto, mitigación y adaptación'. ",
    fill = "Categoría"
  ) +
  theme_minimal() +
  theme(
    legend.text = element_text(size=10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0, margin = margin(b = 20)),
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-50), color = "#555555"),
    panel.grid = element_blank(), 
    axis.title = element_blank(), 
    axis.text = element_blank(),  
    axis.ticks = element_blank()

  )


```


```{r}
CC_MAG <- BASE %>%
  group_by(CambioClimaticoA) %>%
  filter(RegionAB == "MAGALLANES") %>%
  summarise(MONTO2025 = sum(`Monto 2025`, na.rm = TRUE)) %>% 
  mutate(
    Porcentaje = round((MONTO2025 / sum(MONTO2025)) * 100,2),
    Porcentaje = scales::comma(Porcentaje, big.mark = ".",decimal.mark = ",",accuracy = 0.01)
  ) %>% filter(CambioClimaticoA != "NA")


CC_MAG %>%
  mutate(MONTO2025 = scales::comma(MONTO2025, big.mark = ".", decimal.mark = ",")) %>% 
  kable(
    "html",
    col.names = c("Cambio Climático", "Inversión 2025", "Porcentaje") ) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    font_size = 14
  )%>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 50: Desglose de la categoría 'Otros' de los proyectos relacionados a Cambio Climático para la región de Magallanes y de la Antártica Chilena. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria</span>", escape = FALSE, general_title = "")

```



```{r, fig.cap = NULL}


SH_MAG <- BASE %>%
  filter(RegionAB == "MAGALLANES") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round((monto2025 / sum(monto2025)) * 100,2)
  )

ggplot(SH_MAG, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(porcentaje, nsmall = 1, decimal.mark = ","), "%)")
    ),
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Asignación de la Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para la \nregión de Magallanes y de la Antártica Chilena",
    x = NULL,
    y = "",
    caption = "Figura 70: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara la región de Magallanes y de la Antártica Chilena. Fuente: Elaboración propia a partir de datos del \nDepartamento de Gestión Presupuestaria. Nota: La categorización del programa dipres fue realizada en cuatro clases. \nLa primera es 'Consumo Humano' que está compuesta por los programas pertenecientes a: agua potable rural \nsemi-concentrado, agua potable rural concentrado y agua potable rural disperso. La segunda es 'Riego' que agrupa: grandes obras de riego, \nconservación de obras de riego, explotación de obras de riego obras de riego. La categoría 'Estudios y otros' reune los \nsiguientes programas asociados a la Dipres: estudio básico, estudio y otros. Finalmente, la categoría 'Gestión' abarca: \nconstrucción de redes de medición, planes estratégicos de recursos hídricos y ampliación de redes de medición."
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85), color = "#555555")
  ) +
  expand_limits(y = c(0, max(SH_MAG$porcentaje) + 5))+
   scale_y_continuous(labels = scales::percent_format(scale = 1, decimal.mark = ","))



```









## Proyectos Interregionales

 
 
 
 
```{r, fig.cap = NULL}
SERVICIOS_INTER <- BASE %>%
  filter(RegionAB == "INTERREGIONAL") %>%
  mutate(
    ServicioAgrupado = case_when(
      Servicio %in% c("DA", "DAP","DP","DOH") ~ "OTROS",
      TRUE ~ Servicio
    )
  ) %>%
  group_by(ServicioAgrupado) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = round(Monto2025 / sum(Monto2025) * 100,2))


ggplot(SERVICIOS_INTER , aes(x = reorder(ServicioAgrupado, -Monto2025), y = Monto2025, fill = ServicioAgrupado)) +
  geom_bar(stat = "identity", width = 0.6) +
  geom_text(aes(label = paste0(scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), "\n", round(Porcentaje,3), "%")
    ), vjust = -0.5, size = 3.5, 
    color = "black", 
    fontface = "bold",) +
  labs(title = "Distribución de Inversión 2025 por servicios MOP para Proyectos Interregionales",
       x = "",
       y = "Inversión (miles de pesos)",
  caption = "Figura 71: Inversión 2025 para los servicios asociados al MOP para los Proyectos Interregionales. Fuente: Elaboración propia \na partir de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' comprende los servicios \nDA, DAP, DOH y DP." ) +

    scale_fill_manual(values = colores_servicios) +
  scale_y_continuous(limits = c(0, max(SERVICIOS_INTER$Monto2025) * 1.3), labels = label_number(scale = 1e-6, suffix = "M")) +
  theme_minimal()+
  theme(legend.position = "none",
        panel.background = element_rect(fill = "white", color = NA), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.5),

 plot.title = element_text(size = 12, face = "bold", hjust = 0.5, margin = margin(b = 20)),
         plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555"))



otros_data_INTER <- BASE %>%
  filter(RegionAB == "INTERREGIONAL") %>% 
  group_by(Servicio) %>%
  summarise(Monto = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(Porcentaje = Monto / sum(Monto) * 100) %>% 
  filter(Servicio %in% c("DA", "DAP","DP","DOH")) %>%
  mutate(
    Monto = scales::comma(Monto, big.mark = ".", decimal.mark = ","),
    Porcentaje = scales::comma(round(Porcentaje, 3), big.mark = ".", decimal.mark = ",")
  )



kable(otros_data_INTER, "html", col.names = c("Servicio", "Inversión 2025", "Porcentaje (%)")) %>%
  kable_styling(full_width = FALSE, 
                bootstrap_options = c("striped", "hover", "condensed", "responsive"))%>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 51: Servicios agrupados en ‘Otros’, los cuáles incluyen DA, DAP, DOH y DP para los Proyectos Interregionales. Fuente: Tabla construída a partir de los datos del Departamento de Gestión Presupuestaria.</span>", general_title = "",escape = FALSE)



```

 
 
 
 
```{r, fig.cap = NULL}

tab_eje_ministerial_cat_INTERREGIONAL <- BASE %>%
  filter(RegionAB == "INTERREGIONAL" ) %>% 
  group_by(`Eje Ministerial`, Categoría) %>%
  summarise(Monto2025 = sum(`Monto 2025`), .groups = "drop") %>%
  ungroup() %>%  
  mutate(
    total_global = sum(Monto2025),  
    porcentaje = round(Monto2025 / total_global * 100,1) 
  )


ggplot(tab_eje_ministerial_cat_INTERREGIONAL, aes(x = `Eje Ministerial`, y = Monto2025, fill = `Eje Ministerial`)) +
  facet_wrap(~ Categoría, labeller = as_labeller(c("Arrastre" = "Proyectos de Arrastre", "Nuevo" = "Proyectos Nuevos"))) +
  labs(
    x = "", 
    y = "Inversión (miles de pesos)", 
    title = "Inversión 2025 por Clasificación del Proyecto (Arrastre y Nuevo) y Eje Ministerial \n para los Proyectos Interregionales",
    fill = "",
    caption = "Figura 72: Inversión 2025 por categoría de proyecto (nuevo y arrastre) y por los cuatro ejes ministeriales para los Proyectos \nInterregionales. Fuente: Elaboración propia a partir de los datos del Departamento de Gestión Presupuestaria."

  ) + 
  geom_bar(stat = "identity", width = 0.6) + 
  geom_text(
    aes(
      label = paste0(
  scales::comma(Monto2025, big.mark = ".", decimal.mark = ","), 
  "\n", 
  scales::comma(porcentaje, big.mark = ".", decimal.mark = ","), "%"
)

    ), 
    vjust = -0.5, 
    size = 3.5, 
    color = "black", 
    fontface = "bold",
    show.legend = FALSE
  ) +
   scale_fill_manual(values = colores) + 
theme(
    panel.background = element_rect(fill = "white", color = NA),
     panel.spacing = unit(0.8, "lines"), 
    panel.border = element_rect(color = "black", fill = NA, size = 0.0005),
    axis.text.x = element_blank(), 
    axis.text.y = element_text(size = 9),
    strip.text = element_text(size = 9),
    strip.background = element_rect(fill = "white", color = "black"),
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_line(color = "gray90"),
    legend.text = element_text(size = 8.5),
    legend.title = element_blank(),
    legend.position = "bottom",
    legend.justification = c(0.9, 0),
    legend.spacing.x = unit(0.05, "cm"),  
    legend.spacing.y = unit(0.02, "cm"),
    legend.box = "horizontal", 
    legend.key.size = unit(0.4, "cm"),
    legend.box.spacing = unit(0.5, "cm"), 
    plot.margin = margin(t = 10, r = 10, b = 10, l = 10),
    plot.title = element_text(size = 10, face = "bold", hjust = 0.5, margin = margin(b = 20)), 
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-45), color = "#555555")) +
  guides(fill = guide_legend(nrow = 2, byrow = TRUE)) + 
  scale_y_continuous(
    labels = label_number(scale = 1e-6, suffix = "M"),
    expand = expansion(mult = c(0, 0.3))
  )


```





```{r, fig.cap = NULL}
CC_NA_OTROS_INTER <- BASE %>%
  filter(RegionAB == "INTERREGIONAL") %>%
  mutate(CambioClimaticoA = ifelse(is.na(CambioClimaticoA), "No Aplica", "Otros")) %>%
  group_by(CambioClimaticoA) %>%
  summarise(Monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round(Monto2025 / sum(Monto2025) * 100, 2),
    porcentaje = scales::comma(porcentaje, big.mark = ".", decimal.mark = ",", accuracy = 0.01),
    etiqueta = paste0(CambioClimaticoA, "\n", porcentaje, "%"),
    leyenda_texto = paste0(CambioClimaticoA, " - ", scales::comma(Monto2025, big.mark = ".", decimal.mark = ","))
  )

ggplot(CC_NA_OTROS_INTER, aes(x = "", y = Monto2025, fill = CambioClimaticoA)) +
  geom_bar(stat = "identity", width = 1, color = "white") + 
  coord_polar("y", start = 0) + 
  geom_text(
    aes(label = etiqueta), 
    position = position_stack(vjust = 0.5), 
    size = 4, 
    color = "black",
    fontface = "bold"
  ) +
  scale_fill_manual(
    values = alpha(c( "#578E7E","cornsilk3"), .7),
    labels = CC_NA_OTROS_INTER$leyenda_texto
  ) +
  labs(
    title = "Distribución porcentual de inversiones 2025 por categoría de Cambio Climático \npara Proyectos Interregionales",
        caption = "Figura 73: Inversiones 2025 según tipo de proyecto vinculado al Cambio Climático para los Proyectos Interregionales. Fuente: Elaboración propia a partir \n de los datos del Departamento de Gestión Presupuestaria. Nota: La categoría 'Otros' incluye a aquellos proyectos \npertenecientes a 'Adaptación', 'Mitigación' y 'Mixto, mitigación y adaptación'. ",
    fill = "Categoría"
  ) +
  theme_minimal() +
  theme(
    legend.text = element_text(size=10),
    plot.title = element_text(size = 12, face = "bold", hjust = 0, margin = margin(b = 20)),
    plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-50), color = "#555555"),
    panel.grid = element_blank(), 
    axis.title = element_blank(), 
    axis.text = element_blank(),  
    axis.ticks = element_blank()
  )


```


```{r}
CC_INTER <- BASE %>%
  group_by(CambioClimaticoA) %>%
  filter(RegionAB == "INTERREGIONAL") %>%
  summarise(MONTO2025 = sum(`Monto 2025`, na.rm = TRUE)) %>% 
  mutate(
    Porcentaje = round((MONTO2025 / sum(MONTO2025)) * 100,2),
    Porcentaje = scales::comma(Porcentaje, big.mark = ".",decimal.mark = ",",accuracy = 0.01)
  ) %>% filter(CambioClimaticoA != "NA")


CC_INTER %>%
  mutate(MONTO2025 = scales::comma(MONTO2025, big.mark = ".", decimal.mark = ",")) %>% 
  kable(
    "html",
    col.names = c("Cambio Climático", "Inversión 2025", "Porcentaje")) %>%
  kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"),
    full_width = FALSE,
    font_size = 14
  )%>% 
  footnote(general = "<span style='font-size: 12px;'>Tabla 52: Desglose de la categoría 'Otros' de los proyectos relacionados a Cambio Climático para los Proyectos Interregionales. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria</span>", escape = FALSE, general_title = "")

```



```{r, fig.cap = NULL}


SH_INTER <- BASE %>%
  filter(RegionAB == "INTERREGIONAL") %>% 
  filter(`Eje Ministerial` == "Seguridad hídrica" & Categoría == "Nuevo") %>%
  group_by(AGUA_DIPRES) %>%
  summarise(monto2025 = sum(`Monto 2025`, na.rm = TRUE)) %>%
  mutate(
    porcentaje = round((monto2025 / sum(monto2025)) * 100,2)
  )

ggplot(SH_INTER, aes(x = reorder(AGUA_DIPRES, porcentaje), y = porcentaje)) +
  geom_segment(aes(xend = AGUA_DIPRES, y = 0, yend = porcentaje), color = "gray") + 
  geom_point(aes(size = porcentaje), color = "skyblue", fill = "white", shape = 21, stroke = 3) + 
  geom_text(
    aes(
      label = paste0(scales::comma(monto2025, big.mark = ".", decimal.mark = ","), 
               "\n(", format(porcentaje, nsmall = 1, decimal.mark = ","), "%)")
    ),
    fontface = "bold",
    vjust = 1.6,
    size = 3.5
  ) +
  coord_flip() + 
  labs(
    title = "Inversión 2025 en Nuevos Proyectos del Eje de Seguridad Hídrica para los \nProyectos Interregionales",
    x = NULL,
    y = "",
    caption = "Figura 74: Inversión 2025 en proyectos categorizados como nuevos pertenencientes al Eje Ministerial de Seguridad Hídrica \npara Proyectos Interregionales. Fuente: Elaboración propia a partir de datos del Departamento de Gestión Presupuestaria. \nNota: La categorización del programa dipres fue realizada en cuatro clases. La primera es 'Consumo Humano' que está \ncompuesta por los programas pertenecientes a: agua potable rural semi-concentrado, agua potable rural concentrado y \nagua potable rural disperso. \nLa segunda es 'Riego' que agrupa: grandes obras de riego, conservación de obras de riego, explotación de obras de riego \ny obras de riego. La categoría 'Estudios y otros' reune los siguientes programas asociados a la Dipres: estudio básico, \nestudio y otros. Finalmente, la categoría 'Gestión' abarca: construcción de redes de medición, planes estratégicos de \nrecursos hídricos y ampliación de redes de medición."
  ) +
  theme_minimal() +
  theme(
panel.grid.major.y = element_blank(),
    legend.position = "none",
    panel.grid.minor = element_blank(),
    panel.grid.major.x = element_line(color = "gray", linetype = "dashed"),
    axis.text.y = element_text(size = 8),
  plot.title = element_text(size = 10, hjust = 0.5, face = "bold", margin = margin(b = 20,r=100)),
   plot.caption = element_text(hjust = 0, size = 9, margin = margin(t = 10, r = 100, b = 5, l=-85), color = "#555555")
  ) +
  expand_limits(y = c(0, max(SH_INTER$porcentaje) + 5))+
  scale_y_continuous(labels = scales::percent_format(scale = 1, decimal.mark = ","))



```





## Conclusiones

## Bibliografía
